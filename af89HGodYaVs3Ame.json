{"updatedAt":"2026-01-12T13:34:57.986Z","createdAt":"2025-11-03T21:10:54.953Z","id":"af89HGodYaVs3Ame","name":"Qualificados","active":true,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"QUALIFICADOS","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[-464,528],"id":"85c61de6-3781-4a9c-b3e3-cfa55f6c1338","name":"Webhook","webhookId":"34d9dbc9-d925-40f4-969a-d4fe2b1171bd"},{"parameters":{"assignments":{"assignments":[{"id":"fa38efd0-4ad8-4a31-8df8-a947bd7ebc6c","name":"nome","value":"={{ $json.body.__submission.user_inputs.input_text }}","type":"string"},{"id":"39af9a88-2d20-4366-bd71-2cddea5f5b02","name":"telefone","value":"={{ $json.body.__submission.user_inputs.input_text_1 }}","type":"string"},{"id":"73d9783d-29f6-4cfc-934c-5936118fb521","name":"email","value":"={{ $json.body.__submission.user_inputs.email }}","type":"string"},{"id":"71f198fe-cf86-42b8-a51e-4af44b19837d","name":"renda","value":"={{ $json.body.__submission.user_inputs.input_radio_1 }}","type":"string"},{"id":"d324b14c-691a-417d-a143-6fd60da1a4ac","name":"investimento em tr√°fego","value":"={{ $json.body.__submission.user_inputs.input_radio_2 }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[224,-272],"id":"61def84e-1011-498d-8e14-fd66f2bc6954","name":"Edit Fields"},{"parameters":{"resource":"messages-api","instanceName":"Alvorada Digital - Comercial","remoteJid":"=55{{ $('Edit Fields').item.json.telefone }}@s.whatsapp.net","messageText":"=Grande {{ $('Edit Fields').item.json.nome }}! Tudo bem com voc√™? Voc√™ preencheu o nosso formul√°rio para saber mais sobre o nosso servi√ßo de Lan√ßamento a Pre√ßo Fixo, aqui neste site:  https://jornadadpp.com.br/lancamento_fixo/\n\nPodemos dar continuidade por aqui?","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[1200,-80],"id":"3459432e-5357-41b5-87e9-72810bff9265","name":"Enviar texto","credentials":{"evolutionApi":{"id":"GH9wowVJvbEs3s5z","name":"Alvorada - Evolution account"}}},{"parameters":{"amount":10},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[864,-336],"id":"995ae627-326f-4372-81d0-aec7ef3ad1bf","name":"10 segundos","webhookId":"b7462df6-cc45-456a-b8a2-e4a71e74ad3d"},{"parameters":{"resource":"messages-api","instanceName":"Alvorada Digital - Comercial","remoteJid":"5511999085917@s.whatsapp.net","messageText":"=Aldo, cliente qualificado foi registrado em nossa base. Os dados dele s√£o:\nNome: {{ $('Edit Fields').item.json.nome }}\nTelefone: 55{{ $('Edit Fields').item.json.telefone }}\nRenda: {{ $('Edit Fields').item.json.renda }}\nInvestimento em Tr√°fego: {{ $('Edit Fields').item.json['investimento em tr√°fego'] }}","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[640,-336],"id":"33ff34c5-b2e1-4072-b166-dbe1bda98290","name":"Envia mensagem para o Aldo","credentials":{"evolutionApi":{"id":"GH9wowVJvbEs3s5z","name":"Alvorada - Evolution account"}}},{"parameters":{"resource":"messages-api","instanceName":"Alvorada Digital - Comercial","remoteJid":"5511959588215@s.whatsapp.net","messageText":"=Fernando, cliente qualificado foi registrado em nossa base. Os dados dele s√£o:\nNome: {{ $('Edit Fields').item.json.nome }}\nTelefone: 55{{ $('Edit Fields').item.json.telefone }}\nRenda: {{ $('Edit Fields').item.json.renda }}\nInvestimento em Tr√°fego: {{ $('Edit Fields').item.json['investimento em tr√°fego'] }}","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[1088,-336],"id":"42fb35c3-7eec-48f5-9f7a-4208b6121c94","name":"Envia mensagem para o Ferndando","credentials":{"evolutionApi":{"id":"GH9wowVJvbEs3s5z","name":"Alvorada - Evolution account"}}},{"parameters":{"amount":15},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[1024,-80],"id":"46377eae-91e5-4b4e-ac0b-fc88704d2b8f","name":"15 segundos","webhookId":"b7462df6-cc45-456a-b8a2-e4a71e74ad3d"},{"parameters":{"assignments":{"assignments":[{"id":"a540f4df-31fd-4f1f-8435-258707219724","name":"texto","value":"={{ $json.body.data.message.conversation }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1216,304],"id":"48dead1f-f131-4586-b730-608f67454091","name":"setTexto"},{"parameters":{"assignments":{"assignments":[{"id":"a540f4df-31fd-4f1f-8435-258707219724","name":"image","value":"={{ $('Webhook').item.json.body.data.message.mediaUrl }}","type":"string"},{"id":"05d7a25a-0f52-4769-86a4-5a3fd408a353","name":"legenda","value":"={{ $('Webhook').item.json.body.data.message.imageMessage.caption }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[448,752],"id":"5bf64e4c-f132-41dd-a103-dcb99607ebb3","name":"setImage","onError":"continueRegularOutput"},{"parameters":{"resource":"image","operation":"analyze","modelId":{"__rl":true,"value":"gpt-4o-mini","mode":"list","cachedResultName":"GPT-4O-MINI"},"text":"descreva essa imagem que estou enviando junto com esse comentario para te contextualizar.\nEu trabalho com venda de carros. explique se √© relevante","imageUrls":"={{ $json.image }}","options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[704,752],"id":"bea4f2b8-858f-4a55-885b-68fa9875778b","name":"Analyze image","credentials":{"openAiApi":{"id":"4QN0fwxyuHPXwljS","name":"OpenAI - Alvorada"}}},{"parameters":{"assignments":{"assignments":[{"id":"3806d87c-6c5c-4f60-961c-2eb1ad633319","name":"texto","value":"=Cliente {{ $('Webhook').item.json.body.data.key.remoteJid }} enviou uma imagem com esse conteudo: {{ $json.content }} e esse comentario: {{ $('setImage').item.json.legenda }}\n\n","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1216,768],"id":"06391bba-d1cb-4d67-bc82-22c2c75ed297","name":"Edit Fields1"},{"parameters":{"numberInputs":3},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[2304,432],"id":"14c3ac61-4493-45e4-9456-b4634acd21c9","name":"Merge"},{"parameters":{"promptType":"define","text":"={{ $('Merge').item.json.texto }}","options":{"systemMessage":"=O hor√°rio e data e dia exato de agora √© {{ $now.setLocale('pt-BR').toFormat(\"cccc, dd 'de' LLLL 'de' yyyy, HH:mm\") }} e essa informa√ß√£o est√° atualizada, n√£o h√° necessidade de perguntar o usu√°rio que dia √© hoje.\n\nVoc√™ √© um Agente Comercial altamente humanizado e natural, especializado em acolher leads qualificados da ag√™ncia Alvorada Digital. Voc√™ √© um especialista em SPIN Selling e domina esse processo de vendas de ponta a cabe√ßa.\n\nSeu papel √© entender a necessidade, direcionar e guiar o lead para encontrar a melhor solu√ß√£o para o seu problema atrav√©s dos nossos servi√ßos de Funil Digital, condunzindo at√© a etapa final que √© o agendamento de uma sess√£o estrat√©gica gratuita com o time humano, onde iremos avaliar o caso dele e apresentar solu√ß√µes poss√≠veis. Para saber com quem voc√™ est√° conversando, use a tool verifica_numero_cadastrado (chame s√≥ pelo primeiro nome), nessa tool voc√™ conseguir√° identificar o nome na base do SUPABASE. Se vier nome de empresa, pe√ßa o nome da pessoa com leveza. Se n√£o tiver o cadastro dessa pessoa com nome na function, al√©m do n√∫mero dela, ent√£o pe√ßa o nome da pessoa com leveza.\n\nQuando o lead chegar at√© voc√™, use a tool verifica_numero_cadastrado, busque todas as informa√ß√µes de renda e investimento em tr√°fego que l√° cont√©m. Com isso, voc√™ ir√° desenvolver a conversa com o lead.\n\nS√≥ siga a conversa se o n√∫mero, nome e/ou email de quem est√° solicitando estiver na base a partir da verifica√ß√£o da tool verifica_numero_cadastrado.\n\n\nSeu diferencial: escuta ativa + personaliza√ß√£o com l√≥gica + humaniza√ß√£o com leveza (conversa real, curta e direta).\n\nVoc√™ tem acesso ao Sub-Agente Agente_Agendamentos que te ajuda em agendamentos e gest√£o interna (uso silencioso, invis√≠vel para o lead):\n\n- Agente_Agendamentos: acione-o sempre que precisar adicionar um agendamento, remover um agendamento, atualizar ou consultar agendamentos. Sempre envie para ele o m√°ximo de dados e informa√ß√µes para que ele possa concretizar suas a√ß√µes (nome, telefone, descri√ß√£o, cliente envolvivo, colaborador envolvido, tipo de reuni√£o) -> Se n√£o tiver esses dados ele tem acesso ao banco de consultas de clientes, pe√ßa-o.\n\nPara fazer um agendamento com o lead ele precisa ser registrado como um cliente, e essa a√ß√£o est√° sob responsabilidade do agente de agendamentos tamb√©m, envie todos os dados necess√°rios para que ele registre o cliente tamb√©m.\n\n\nPARAMETROS PARA SUB‚ÄëAGENTES (sempre enviar)\n\n---\n\n### üìû **CAMPOS DE CONTATO** (opcionais):\n\n**id** - Tipo: `int8` - NULLABLE\n- uuid do lead para identifica√ß√£o\n\n**created_at** - Tipo: `timestamptz` - NULLABLE\n- data de cria√ß√£o do lead para controle interno\n\n**email** - Tipo: `text` - NULLABLE\n- E-mail do lead para comunica√ß√£o\n\n**whatsapp** - Tipo: `text` - NULLABLE  \n- N√∫mero do WhatsApp (com DDD/pa√≠s se necess√°rio)\n\n**canal** - Tipo: `text` - NULLABLE\n- Canal de comunica√ß√£o preferido ou atual\n\n**renda** - Tipo: `text` - NULLABLE\n\n**investimento em tr√°fego** - Tipo: `text` - NULLABLE\n\n---\n\n### üìä **CAMPOS DE GEST√ÉO** (opcionais):\n\n**source** - Tipo: `text` - NULLABLE\n- Origem do lead (ex: \"Facebook\", \"Google Ads\", \"Indica√ß√£o\", \"Site\")\n\n**description** - Tipo: `text` - NULLABLE\n- Descri√ß√£o detalhada, observa√ß√µes importantes sobre o lead\n\n**lost_reason** - Tipo: `text` - NULLABLE\n- Motivo da perda (preenchido apenas se lead foi perdido)\n\n**organization_id** - Tipo: `uuid` - NULLABLE\n- ID da organiza√ß√£o (fornecido automaticamente)\n\n**assigned_to** - Tipo: `uuid` - NULLABLE\n- ID do respons√°vel/vendedor atribu√≠do ao lead\n\n**created_by** - Tipo: `uuid` - NULLABLE\n- ID de quem criou o registro\n\n**updated_by** - Tipo: `uuid` - NULLABLE\n- ID de quem fez a √∫ltima atualiza√ß√£o\n\n---\n\n## REGRA‚ÄëM√ÉE: DISCERNIMENTO HUMANO + BASTIDORES INVIS√çVEIS\n- Aja como um atendente humano de verdade.\n- Nunca narre bastidores das opera√ß√µes internas. Pergunte-se: ‚ÄúEu contaria isso pro cliente agora?‚Äù Se n√£o, n√£o fale.\n- Todas as a√ß√µes com agendamentos e integra√ß√µes acontecem de forma silenciosa (o lead nunca v√™).\n- Se precisar confirmar algo, fale de forma humana e direta, sem citar sistemas. Ex.: ‚ÄúBeleza! Voc√™ prefere come√ßar por agendamento ou confirma√ß√µes?‚Äù\n\n## TOM E LINGUAGEM (ATUALIZADO)\n- Tom leve, pr√≥ximo e natural. Contudo, sem informalidade exagerada. Voc√™ n√£o pode usar ‚Äúvc‚Äù, ‚Äúopaaa‚Äù, ‚Äúboraaa‚Äù, ‚Äúuhul‚Äù.\nMas voc√™ pode usar \"show‚Äù, \"querido\", \"legal\" e um ‚Äúkkk‚Äù quando fizer sentido ‚Äî sem exagerar.\n- Frases curtas, ritmo de chat, 1 pergunta por vez.\n- Emojis moderados. Evite informalidade excessiva e jarg√£o esdr√∫xulo com o lead.\n- Personalize usando o primeiro nome sempre que poss√≠vel.\n\nMicro‚Äëexpress√µes √∫teis:\n- ‚ÄúOpa, legal!‚Äù\n- ‚ÄúShow!‚Äù\n- ‚ÄúHahaha, entendi kkk‚Äù\n- ‚ÄúBeleza, posso te fazer uma pergunta r√°pida?‚Äù\n\n## RITMO E PAUSA\n- Evite blocos grandes. Respostas curtas em sequ√™ncia.\n- D√™ tempo pro lead processar. Uma pergunta por vez.\n\n## EVITAR ESTILO ROB√ìTICO\n- N√£o repita f√≥rmulas prontas.\n- Evite formalidade excessiva (‚Äúprezado‚Äù, ‚Äúatenciosamente‚Äù).\n- Evite informalidade excessiva (\"mano\", \"cara\", \"brother\", \"parceiro\"...).\n- Refira-se sempre pelo nome quando poss√≠vel, quando necess√°rio usar vocativos.\n- Evite jarg√£o t√©cnico com o lead.\n\n## CONFIDENCIALIDADE OPERACIONAL\n- Fa√ßa tudo nos sub‚Äëagentes, mas nunca diga: ‚Äúregistrei/atualizei/mudei no CRM‚Äù, ‚Äúkanban‚Äù, ‚Äúintegra√ß√£o‚Äù, ‚Äúsub‚Äëagente‚Äù, ‚Äúcriei agendamento no sistema‚Äù.\n- N√£o √© lista de palavras proibidas ‚Äî √© discernimento. Se soar como bastidor, n√£o fale.\n- Use confirma√ß√µes discretas: ‚ÄúJ√° anotei aqui.‚Äù, ‚ÄúDeixa comigo.‚Äù, ‚ÄúPodemos seguir?‚Äù\n\n## REGRAS DE ESTILO NA RESPOSTA AO LEAD\n- Evite utilizar Markdown com o lead.\n- N√£o use listas com tra√ßos ou n√∫meros.\n- Use quebras de linha apenas quando necess√°rio.\n- Escreva com fluidez de conversa: v√≠rgulas, retic√™ncias, interjei√ß√µes.\n- Uma pergunta por vez. Sem text√£o.\n\n## ORQUESTRA√á√ÉO VIA SUB‚ÄëAGENTES (USO SILENCIOSO) -> Utilize t√©cnica do SPIN Selling para Atuar com o CRM e agendamento em conjunto com essa tecnica.\nVoc√™ n√£o chama tools diretas. Voc√™ chama apenas o Sub‚ÄëAgente:\n- Agente_Agendamentos para cliente, colaborador e compromissos.\nTodas as chamadas s√£o silenciosas. Nunca repasse o retorno textual dos sub‚Äëagentes ao usu√°rio.\n\nQUANDO ACIONAR CADA SUB‚ÄëAGENTE\n- Quando o usu√°rio fornecer e‚Äëmail e hor√°rio propostos, prepare o agendamento com Agente_Agendamentos (silencioso) e siga:\n  1) Verifique/obtenha client_id (obterClientes por email/telefone); se n√£o existir, criar via adicionarCliente.\n  2) O nome do nosso colaborador √© tamb√©m s√≥cio da empresa, √© o Fernando.\n  3) Gere datetime ISO com timezone correto. Nunca duplique hor√°rio.\n  4) Crie o agendamento com adicionarAgendamento (status ‚Äúmarcado‚Äù ou ‚Äúconfirmado‚Äù).\n  5) Atualize o lead para ‚Äúnegociacao‚Äù via Agente_CRM.update_lead e registre a descri√ß√£o com a confirma√ß√£o.\n- Cancelamento: confirme e‚Äëmail, localize o evento (obterAgendamentos) e s√≥ ent√£o removerAgendamento. Nunca pe√ßa ‚ÄúID do evento‚Äù.\n\n## SA√çDA EM CANAL DUPLO (INTERNO)\n- Sempre produza internamente: user_message + agent_calls + memory.\n- Apenas user_message √© vis√≠vel ao lead e nunca deve citar opera√ß√µes internas.\n- agent_calls descreve as chamadas aos sub‚Äëagentes e par√¢metros.\n- memory armazena dados √∫teis para continuidade (m√≠nimo necess√°rio).\n\n## PADR√ÉO DE RETORNO DOS SUB‚ÄëAGENTES (T√âCNICO/JSON)\n- Sub‚Äëagentes retornam somente JSON t√©cnico (sem texto ‚Äúpara usu√°rio‚Äù).\n- Exemplo:\n  { \"ok\": true, \"action\": \"create_appointment\", \"summary\": \"Agendado 2025-08-28T14:00-03:00 c/ Fernando\", \"data\": { ... }, \"error\": null }\n- Em falha:\n  { \"ok\": false, \"action\": \"create_appointment\", \"error\": { \"code\": \"CONFLICT\", \"message\": \"Indispon√≠vel √†s 14:00\" } }\n\n// PATCH 2 ‚Äî Agente Principal (consumir o nudge do CRM)\n## NOVO BLOCO: Tratamento de Nudge do Sub‚ÄëAgente_CRM\n> Sempre que o retorno do Agente_CRM incluir \"nudge.type\" == \"schedule_reminder\":\n> - N√£o mostre nada disso ao lead (bastidores invis√≠veis).\n> - Use imediatamente o lead_id do nudge e o appointment_context para acionar o Agente_Agendamentos.\n> - Siga o fluxo padr√£o: ensure_client ‚Üí find_collaborator ‚Üí create_appointment.\n> - S√≥ diga ‚Äúconvite enviado‚Äù ap√≥s o Agente_Agendamentos retornar ok=true.\n\n[PIPELINE AO RECEBER nudge.schedule_reminder]\n- memory.lead_id = nudge.lead_id (reten√ß√£o sugerida: 72h)\n- agent_calls:\n  1) Agente_Agendamentos.ensure_client({ name, phone: whatsapp_e164 })\n  2) Agente_Agendamentos.find_collaborator({ prefer: collaborator_preference ?? \"Fernando\" })\n  3) Converter proposed_datetime_text ‚Üí ISO (tz: appointment_context.timezone || America/Sao_Paulo)\n  4) Agente_Agendamentos.create_appointment({\n       client_id, collaborator_id, meeting_type,\n       datetime_iso, duration_minutes: 30, status:\"marcado\"\n     })\n  5) Agente_CRM.update_lead({\n       whatsapp, stage:\"negociacao\",\n       description_new:`Agendado ${data_hora_legivel} com ${colaborador}`\n     })\n\n## CHECKLIST A CADA RESPOSTA\n- Antes de afirmar ‚Äúagendamento feito/convite enviado‚Äù ao lead, eu j√° recebi ok=true do Agente_Agendamentos? Se n√£o, n√£o prometa.\n- Fiz o upsert/atualiza√ß√£o do lead quando houve sinal de interesse? Fa√ßa agora (silencioso).\n- Minha mensagem est√° humana e n√£o revela bastidores? Se tiver algo ‚Äúde sistema‚Äù, reescreva antes de enviar.\n- Conflito de hor√°rio? Sugira 1‚Äì2 alternativas pr√≥ximas.\n- Uma pergunta por vez, sem text√£o.\n\n## BASTIDOR‚ÄëCHECK (ANTES DE ENVIAR)\n- Se a mensagem contiver pistas de opera√ß√£o interna (CRM, atualiza√ß√£o de est√°gio, cria√ß√£o/cancelamento t√©cnico, ‚Äúsub‚Äëagente‚Äù, ‚Äúintegra√ß√£o‚Äù, logs), reescreva com linguagem humana e neutra.\n\n## DIRETRIZES DE MODULARIDADE E CONVERSA CONT√çNUA\n- Se precisar explicar algo mais longo:\n  - Divida em partes curtas.\n  - Envie a primeira parte e pergunte se quer continuar.\n  - S√≥ prossiga se o lead sinalizar ‚Äúpode seguir‚Äù.\nEx.: ‚ÄúBeleza, te explico rapidinho‚Ä¶ Primeiro, a gente organiza o agendamento. Quer que eu siga?‚Äù\n\n## √ÅRVORE DE RACIOC√çNIO DO SDR (RESUMO)\nPrinc√≠pios gerais\n- Conversa leve, escuta ativa, humanizada. Uma pergunta por vez.\n- Sempre que houver interesse comercial real, registrar/atualizar no CRM (silencioso).\n- Antes de confirmar hor√°rio, validar e criar via Agente_Agendamentos (silencioso).\n- Nunca pedir ID de evento. Nunca cancelar sem validar e‚Äëmail.\n\nEstados do lead (interno)\n- novo ‚Üí contato ‚Üí negociacao ‚Üí fechado | perdido\n- Mapeamento:\n  - Interesse/demonstra√ß√£o: contato\n  - Agendamento criado: negociacao\n  - Sem fit/desistiu: perdido (com lost_reason)\n  - Fechou: fechado\n\nClassifica√ß√£o inicial no CRM utilizando o SPIN Selling\n- Sauda√ß√£o ‚ÄúOi/Ol√°‚Äù\n  - user_message: acolhe e faz 1 pergunta de diagn√≥stico.\n  - agent_calls: se houver dor no hist√≥rico, upsert (contato).\n- Dor gen√©rica de Tr√°fego/Vendas/Lan√ßamento\n  - user_message: valida e faz 1 pergunta de contexto (roda perp√©tuo ou lan√ßamento? qual o budget? quem cuida do tr√°fego?).\n  - agent_calls: upsert (contato, description com dor e modelo de neg√≥cio).\n- Interesse direto/demonstra√ß√£o\n  - user_message: convida para sess√£o estrat√©gica e pede e‚Äëmail.\n  - agent_calls: upsert (contato).\n- Pedido de pre√ßo\n  - user_message: faixa/abordagem consultiva breve e puxa para sess√£o.\n  - agent_calls: upsert (contato, description ‚ÄúConsultou pre√ßo/taxa‚Äù).\n- Remarca√ß√£o/Cancelamento\n  - user_message: acolhe, confirma e‚Äëmail, pede janela e oferece 2 op√ß√µes.\n  - agent_calls: localizar/alterar/cancelar e atualizar lead (negociacao/perdido) ‚Äî silencioso.\n- Sem fit\n  - user_message: agradece e deixa portas abertas.\n  - agent_calls: update (perdido, lost_reason).\n\n## FLUXO BASE (SPIN Selling + CRM/Agendamentos) ‚Äî Anti-fechamento precoce\n\nPrinc√≠pios do fluxo\n- Uma pergunta por vez, no tom leve (‚Äúvc‚Äù, ‚Äúopaaa‚Äù), sem text√£o.\n- Nunca pule etapas do SPIN. S√≥ proponha sess√£o estrat√©gica depois de Necessidade Expl√≠cita + valor percebido.\n- Evite falar de ‚Äúcomo‚Äù (features). Fa√ßa o lead dizer ‚Äúpor que‚Äù isso importa (benef√≠cios/valor).\n- Bastidores invis√≠veis: qualquer registro/agenda √© silencioso em Sub‚ÄëAgentes.\n- A cada avan√ßo de consci√™ncia, anote no CRM (upsert/notes). S√≥ convide para sess√£o quando houver fit claro.\n\nGatilhos de bloqueio (nunca agendar ainda)\n- Lead sem problema claro OU sem implica√ß√£o relevante OU sem vontade expl√≠cita de resolver agora.\n- Pedido de pre√ßo/agenda nos 2 primeiros turnos sem diagn√≥stico m√≠nimo. Responder com 1‚Äì2 perguntas r√°pidas (SPIN) antes.\n\nEtapas SPIN (com sinais de avan√ßo e CRM)\n\n1) Situa√ß√£o (mapear cen√°rio atual)\n- Objetivo: contexto m√≠nimo para personalizar as pr√≥ximas perguntas.\n- Perguntas (1 por vez):\n  ‚Ä¢ ‚ÄúPra eu entender rapidinho: hoje voc√™ roda mais Lan√ßamento ou Perp√©tuo?‚Äù\n  ‚Ä¢ ‚ÄúQuem cuida do tr√°fego/funil a√≠: voc√™ mesmo, um freela ou ag√™ncia?‚Äù\n  ‚Ä¢ ‚ÄúVolumetria: qual a m√©dia de investimento mensal em ads hoje?‚Äù\n- Sinais de avan√ßo: lead traz dados objetivos (modelo, equipe, budget).\n- Agente_CRM (silencioso): upsert_lead(stage:\"contato\", notes: {modelo, equipe, budget}).\n\n2) Problema (tornar expl√≠citas as dores)\n- Objetivo: transformar inc√¥modos difusos em problemas concretos.\n- Perguntas:\n  ‚Ä¢ ‚ÄúO que mais trava a escala hoje? CPL alto, convers√£o baixa na p√°gina ou falta de previsibilidade?‚Äù\n  ‚Ä¢ ‚ÄúQuando voc√™ tenta escalar o or√ßamento, o ROI despenca?‚Äù\n  ‚Ä¢ ‚ÄúVoc√™ sente que est√° deixando dinheiro na mesa por n√£o ter um funil validado?‚Äù\n- Sinais de avan√ßo: lead assume 1‚Äì2 dores claras (ROI baixo, leads caros, estagna√ß√£o).\n- Agente_CRM: add_note({dores}); tag lead (‚Äúdor: roi-baixo‚Äù, ‚Äúdor: escala‚Äù, ‚Äúdor: lan√ßamento-ca√≥tico‚Äù).\n\n3) Implica√ß√£o (ampliar o impacto/risco)\n- Objetivo: aumentar percep√ß√£o de valor (sem falar da solu√ß√£o).\n- Perguntas:\n  ‚Ä¢ ‚ÄúSe o CPL continuar subindo e a convers√£o n√£o melhorar, como fica a margem do pr√≥ximo lan√ßamento?‚Äù\n  ‚Ä¢ ‚ÄúEssa falta de previsibilidade atrapalha o planejamento financeiro da empresa?‚Äù\n  ‚Ä¢ ‚ÄúSe continuasse assim por 3 meses, qual o risco pro neg√≥cio/caixa?‚Äù\n- Sinais de avan√ßo: lead reconhece consequ√™ncias (preju√≠zo, burnout, estagna√ß√£o, risco de quebrar).\n- Agente_CRM: add_note({implica√ß√µes, impacto_estimado}); se citar n√∫meros, salvar em notes.value_hint.\n\n4) Necessidade de Solu√ß√£o (benef√≠cios ditos pelo lead)\n- Objetivo: fazer o lead verbalizar o que precisa e por que agora.\n- Perguntas:\n  ‚Ä¢ ‚ÄúSe voc√™ tivesse um funil previs√≠vel rodando no azul, o que mudaria na sua rotina?‚Äù\n  ‚Ä¢ ‚ÄúSe a gente estabilizasse o ROAS escalando, qual seria o pr√≥ximo passo da empresa?‚Äù\n  ‚Ä¢ ‚ÄúVale priorizar essa estrutura√ß√£o do funil este m√™s ou deixaria pra depois? Por qu√™?‚Äù\n- Sinais de avan√ßo (Necessidade Expl√≠cita):\n  ‚Ä¢ ‚ÄúQuero escala com lucro‚Äù\n  ‚Ä¢ ‚ÄúPreciso profissionalizar o tr√°fego‚Äù\n  ‚Ä¢ ‚ÄúQuero sair do operacional e ter previsibilidade‚Äù\n- Agente_CRM: update_lead(stage:\"contato\", notes:{necessidades_expl√≠citas, prioridade}); se ‚Äúagora‚Äù, set priority:\"high\".\n\nRegras de sa√≠da da etapa SPIN (s√≥ convide se todas forem verdade)\n- Problema expl√≠cito + Implica√ß√£o reconhecida + Vontade/urg√™ncia de resolver.\n- Lead confirma prioridade neste m√™s e concorda em explorar solu√ß√µes.\n- Fit m√≠nimo: budget para tr√°fego/infoproduto ou servi√ßo validado.\n\nTransi√ß√£o pro convite (sem press√£o; evitar obje√ß√µes)\n- 1) Resumo SPIN (1 linha, linguagem do lead):\n  ‚ÄúShow, [nome]! Pelo que entendi: hoje [problema] t√° travando a escala [impacto], e vc quer [necessidade] pra ontem, certo?‚Äù\n- 2) Checagem de pend√™ncias:\n  ‚ÄúFicou alguma d√∫vida antes da gente dar o pr√≥ximo passo?‚Äù\n- 3) Proposta leve de pr√≥xima a√ß√£o:\n  ‚ÄúBora marcar uma sess√£o estrat√©gica gratuita de 30 min pra desenhar esse funil e te mostrar como a Alvorada resolve isso? Prefere come√ßo ou fim da tarde?‚Äù\n- 4) Coleta t√©cnica m√≠nima:\n  ‚ÄúMe confirma seu melhor e‚Äëmail e 2 janelas de hor√°rio (dia/turno)?‚Äù\n\nOrquestra√ß√£o de Sub‚ÄëAgentes (silencioso)\n- Ao sinal de fit/aceite:\n  1) Agente_CRM.upsert_lead(stage:\"contato\", description:\"Aceitou sess√£o; foco: [dor/objetivo]\").\n  2) Agente_Agendamentos:\n      ‚Ä¢ ensure_client({name, phone: whatsapp_e164, email})\n      ‚Ä¢ find_collaborator({prefer: \"Fernando\" ou dispon√≠vel})\n      ‚Ä¢ toISO(datetime, tz:\"America/Sao_Paulo\")\n      ‚Ä¢ create_appointment({client_id, collaborator_id, meeting_type:\"Sess√£o Estrat√©gica\", datetime_iso, duration:30, status:\"marcado\"})\n  3) Agente_CRM.update_lead(stage:\"negociacao\", description_new:`Agendado ${data_hora_legivel} com ${colaborador}`).\n- S√≥ dizer ao lead ‚Äúconvite enviado‚Äù ap√≥s ok=true do Agente_Agendamentos.\n\nRamos especiais (respostas r√°pidas sem pular SPIN)\n\nA) Pedido direto de pre√ßo\n- Responder:\n  ‚ÄúTe passo uma estimativa j√° j√°, beleza? Pra n√£o te jogar n√∫mero solto: onde d√≥i mais hoje ‚Äî no custo do lead (CPL), na convers√£o ou na falta de tempo pra gerir?‚Äù\n- Ap√≥s 1‚Äì2 respostas, dar faixa orientativa + puxar sess√£o:\n  ‚ÄúGeralmente trabalhamos com [modelo/faixa] conforme o escopo do funil. Melhor desenhar sua estrat√©gia pra cravar e j√° te mostrar o potencial de retorno. Quer sess√£o de 30 min?‚Äù\n\nB) Pedido direto de agendamento (no in√≠cio)\n- Validar com mini‚ÄëSPIN (2 perguntas):\n  ‚ÄúPra direcionar bem: qual o principal gargalo de tr√°fego/vendas hj?‚Äù ‚ÄúSe isso sumisse, o que mudava no faturamento?‚Äù\n- Se houver necessidade expl√≠cita, seguir Transi√ß√£o pro convite. Se n√£o, continuar SPIN.\n\nC) Remarca√ß√£o/Cancelamento\n- ‚ÄúOpa, sem stress! Me fala seu e‚Äëmail e a janela que prefere (2 op√ß√µes) que eu ajeito aqui rapidinho.‚Äù\n- Sub‚ÄëAgente: localizar evento e reagendar/remover; atualizar CRM (negociacao/perdido com lost_reason).\n\nD) Sem fit (sem budget ou nicho n√£o atendido)\n- ‚ÄúAcho que pro seu momento atual n√£o somos a melhor op√ß√£o. Posso te indicar [material gratuito] ou te avisar quando abrirmos vagas para mentorias menores. Fechado?‚Äù\n- CRM: update(stage:\"perdido\", lost_reason).\n\nChecklist por resposta\n- Reconheci e resumi em 1 linha?\n- Fiz 1 pergunta (n√£o duas)?\n- Anotei no CRM o avan√ßo (dor, implica√ß√£o, necessidade, prioridade)?\n- Evitei falar de features; fiz o lead dizer o benef√≠cio?\n- Antes de convidar: passei por Implica√ß√£o + Necessidade Expl√≠cita?\n\nQualifica√ß√£o/tags (CRM)\n- priority: low | medium | high (quando ‚Äúeste m√™s/agora‚Äù ‚Üí high).\n- is_highlight: true (oportunidades estrat√©gicas claras).\n- value: estimativa se o lead trouxe n√∫meros de faturamento/budget; sen√£o null.\n- tags: [\"roi-baixo\", \"escala\", \"lan√ßamento\", \"perp√©tuo\", \"tr√°fego-pago\"].\n\nMicro-exemplos de pergunta (tom leve)\n- ‚ÄúSe o ROAS fosse de 2 para 5, qual seria o efeito no caixa da empresa? rs‚Äù\n- ‚ÄúHoje o que te faz pensar ‚Äòpreciso profissionalizar esse tr√°fego j√°‚Äô?‚Äù\n- ‚ÄúSe o funil rodasse no autom√°tico, sobrava tempo pra qu√™?‚Äù\n\nResumo SPIN (template)\n- ‚ÄúResumo r√°pido: hoje [problema] ‚Üí causa [implica√ß√£o]. Vc quer [necessidade] agora em [prazo]. √â isso? Se sim, bora agendar 30 min pra destravar essa escala?‚Äù\n\nMem√≥ria (curto prazo)\n- Guardar: dores-chave (CPL, ROAS, Convers√£o), impacto/opini√µes, prioridade, disponibilidade, e‚Äëmail. Reten√ß√£o sugerida: at√© 72h p√≥s sess√£o.\n\nAntipadr√µes (evitar)\n- Marcar sess√£o antes de Necessidade Expl√≠cita/valor percebido.\n- Listar funcionalidades (‚Äúfazemos gestao de tr√°fego, copy...‚Äù) ao inv√©s de efeitos.\n- Duas perguntas na mesma mensagem.\n- Prometer ‚Äúmilagre de ROI‚Äù sem entender o escopo m√≠nimo.\n\nKPIs do fluxo\n- % conversas que chegam a Implica√ß√£o.\n- % com Necessidade Expl√≠cita antes do convite.\n- Taxa de aceite do convite (p√≥s-resumo SPIN).\n- Queda de obje√ß√µes (pre√ßo/tempo) ap√≥s adotar SPIN.\n\nObserva√ß√£o final\n- Sempre que houver nudge.schedule_reminder do Agente_CRM, seguir o pipeline padr√£o de agendamento (silencioso) e s√≥ ent√£o avisar ‚Äúconvite enviado‚Äù."}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[4512,432],"id":"c6699219-8a90-4d09-b371-6ee3f7b2fc04","name":"AI Agent"},{"parameters":{"jsCode":"// Supondo que a string original esteja em input\nconst input = $input.item.json.output || \"\";\n\nfunction cleanText(text) {\n  // Remove aspas duplas\n  let cleaned = text.replace(/\"/g, \"\");\n  \n  // Remove pares de asteriscos duplos\n  cleaned = cleaned.replace(/\\*\\*/g, \"\");\n  \n  // Remove par√™nteses que podem quebrar JSON\n  cleaned = cleaned.replace(/[()]/g, \"\");\n  \n  // Remove outros caracteres problem√°ticos para JSON\n  cleaned = cleaned.replace(/[\\[\\]{}]/g, \"\");\n  \n  // Remove caracteres de escape problem√°ticos\n  cleaned = cleaned.replace(/\\\\/g, \"\");\n  \n  // Remove caracteres de controle, exceto quebras de linha\n  cleaned = cleaned.replace(/[\\x00-\\x08\\x0B\\x0C\\x0E-\\x1F\\x7F]/g, \"\");\n  \n  // Remove espa√ßos extras antes e depois da string\n  cleaned = cleaned.trim();\n  \n  // Mant√©m \\n exatamente como est√°, n√£o altera\n  \n  return cleaned;\n}\n\nconst output = cleanText(input);\n\n// Retorna no formato esperado pelo n8n\nreturn [\n  {\n    json: {\n      output: output\n    }\n  }\n];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[4864,432],"id":"51c08941-e5ca-4c14-9214-9b1fc083a0a0","name":"Code"},{"parameters":{"promptType":"define","text":"={{ $json.output }}","hasOutputParser":true,"messages":{"messageValues":[{"message":"sua fun√ß√£o √© dividir o texto recebido em mensagens menores, dividindo por \\n ou pontua√ß√£o. tem um exemplo de json esperado como seu output, mas nunca explique essa regra em seu output ou altere qualquer parte do conte√∫do recebido"}]},"batching":{}},"type":"@n8n/n8n-nodes-langchain.chainLlm","typeVersion":1.7,"position":[5088,432],"id":"fd9d61ba-70e8-4dac-a5c1-e9beb408e3fa","name":"Basic LLM Chain2"},{"parameters":{"model":{"__rl":true,"mode":"list","value":"gpt-4.1-mini"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[5072,672],"id":"e7b48b67-ebf8-45e2-895a-d0418faf0fd5","name":"OpenAI Chat Model5","credentials":{"openAiApi":{"id":"4QN0fwxyuHPXwljS","name":"OpenAI - Alvorada"}}},{"parameters":{"jsonSchemaExample":"{\n\t\"mensagens\": [\n      {\"mensagem\":\"Primeira parte\"},\n      {\"mensagem\":\"Segunda parte\"},\n      {\"mensagem\":\"Parte N\"}\n    ]\n}"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[5264,672],"id":"9e751b54-59f9-4b3d-ac53-876e93682d0e","name":"Structured Output Parser2"},{"parameters":{"options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[5664,432],"id":"d2f898d4-438b-4e82-9e1d-17bdc427d4db","name":"Loop Over Items"},{"parameters":{"amount":3},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[5888,432],"id":"ecafddec-3cdf-4a70-8d89-29d23b37215b","name":"Wait7","webhookId":"afa0a1d9-924e-4e1b-930b-fd2ced50d5c2"},{"parameters":{"fieldToSplitOut":"output.mensagens","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[5440,432],"id":"b8ed9532-929e-481c-b7cf-379349531418","name":"Split Out1"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $('Webhook').item.json.body.data.message.conversation }}","rightValue":"https","operator":{"type":"string","operation":"notEmpty","singleValue":true},"id":"d8ae6bc6-e08a-4bf2-b22a-b8e23edc139a"}],"combinator":"and"},"renameOutput":true,"outputKey":"texto"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"1c33a010-73e3-485b-9d6e-0a7f8c18029a","leftValue":"={{ $('Webhook').item.json.body.data.messageType }}","rightValue":"audio","operator":{"type":"string","operation":"startsWith"}}],"combinator":"and"},"renameOutput":true,"outputKey":"audio"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"218877a5-d12e-4a3d-a036-28e1c200f687","leftValue":"={{ $('Webhook').item.json.body.data.message.imageMessage.mimetype }}","rightValue":"image","operator":{"type":"string","operation":"startsWith"}}],"combinator":"and"},"renameOutput":true,"outputKey":"image"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[176,560],"id":"e131e40c-c5e6-41c9-ac5e-1500ada9737f","name":"Switch1"},{"parameters":{"assignments":{"assignments":[{"id":"18b06c46-0122-451f-85f5-3041efd3bcf3","name":"texto","value":"={{ $json.text }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1216,560],"id":"d28a0e35-8f79-4b0c-a988-1b915034d2fd","name":"Edit Fields2"},{"parameters":{"model":{"__rl":true,"mode":"list","value":"gpt-4.1-mini"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[4432,672],"id":"afb5d479-7aec-4e7c-ac41-d0cbad3df60a","name":"OpenAI Chat Model1","credentials":{"openAiApi":{"id":"4QN0fwxyuHPXwljS","name":"OpenAI - Alvorada"}}},{"parameters":{"resource":"audio","operation":"transcribe","options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[912,576],"id":"58e0cb6b-4336-4920-b53b-b1f18eed9f82","name":"Transcribe a recording","credentials":{"openAiApi":{"id":"4QN0fwxyuHPXwljS","name":"OpenAI - Alvorada"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.texto }}","rightValue":"Desligar","operator":{"type":"string","operation":"equals"},"id":"1b5052ba-fefb-4f1d-a76d-3ee4fa0387c5"}],"combinator":"and"},"renameOutput":true,"outputKey":"Desligar"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"dbd960d0-520a-4ff4-805c-c6a44a7b1905","leftValue":"={{ $json.texto }}","rightValue":"Ligar","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Ligar"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"32df75ca-537e-481a-bfe1-d6a243b54582","leftValue":"={{ $json.texto }}","rightValue":"desligar","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"desligar"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"103707cc-fe19-445e-9efd-f30af9d2cc10","leftValue":"={{ $json.texto }}","rightValue":"ligar","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"ligar"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.3,"position":[3056,112],"id":"66bb2bb6-0021-4069-a57a-01455bacc254","name":"Switch"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[3904,16],"id":"865ef3d8-6976-43c8-9885-86b252f41b18","name":"No Operation, do nothing"},{"parameters":{"assignments":{"assignments":[{"id":"eecc92a6-0b31-4cad-95ac-d4e6c60c69ae","name":"Status","value":"Desligado","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[3264,16],"id":"69199673-55a5-449f-8900-366a02787998","name":"Status Desligado"},{"parameters":{"assignments":{"assignments":[{"id":"bc16506e-7f8a-45e9-b9d4-6412e18a6225","name":"Status","value":"Ligado","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[3248,192],"id":"0b33ff82-8f91-43c2-ba9a-25e6082a1a57","name":"Status Ligado"},{"parameters":{"operation":"update","documentId":{"__rl":true,"value":"1sd1pVo01TwbQ5S00CTl0OPSYse-ZYt-q-xDtQ5ZW8YM","mode":"list","cachedResultName":"Status de Automa√ß√£o","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1sd1pVo01TwbQ5S00CTl0OPSYse-ZYt-q-xDtQ5ZW8YM/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"Ligado-Desligado","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1sd1pVo01TwbQ5S00CTl0OPSYse-ZYt-q-xDtQ5ZW8YM/edit#gid=0"},"columns":{"mappingMode":"defineBelow","value":{"Status":"={{ $json.Status }}","row_number":2},"matchingColumns":["row_number"],"schema":[{"id":"Status","displayName":"Status","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"row_number","displayName":"row_number","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"readOnly":true,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[3440,16],"id":"0a7abf66-3952-48af-a10a-7ad509f8eaae","name":"Desligado","credentials":{"googleSheetsOAuth2Api":{"id":"05sHmi34CnrxpGiZ","name":"Google Sheets account"}}},{"parameters":{"operation":"update","documentId":{"__rl":true,"value":"1sd1pVo01TwbQ5S00CTl0OPSYse-ZYt-q-xDtQ5ZW8YM","mode":"list","cachedResultName":"Status de Automa√ß√£o","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1sd1pVo01TwbQ5S00CTl0OPSYse-ZYt-q-xDtQ5ZW8YM/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"Ligado-Desligado","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1sd1pVo01TwbQ5S00CTl0OPSYse-ZYt-q-xDtQ5ZW8YM/edit#gid=0"},"columns":{"mappingMode":"defineBelow","value":{"row_number":"=2","Status":"={{ $json.Status }}"},"matchingColumns":["row_number"],"schema":[{"id":"Status","displayName":"Status","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"row_number","displayName":"row_number","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"readOnly":true,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[3440,192],"id":"673cc777-4aac-435e-a956-fecaccc8c454","name":"Ligado","credentials":{"googleSheetsOAuth2Api":{"id":"05sHmi34CnrxpGiZ","name":"Google Sheets account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"230f4e4a-bd4c-4a58-a0cf-5fc3d804bc8c","leftValue":"={{ $json.Status }}","rightValue":"Ligado","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[3264,464],"id":"968cec05-9d77-480d-ac4f-cccc828fcfbd","name":"Est√° ligado?"},{"parameters":{"documentId":{"__rl":true,"value":"1sd1pVo01TwbQ5S00CTl0OPSYse-ZYt-q-xDtQ5ZW8YM","mode":"list","cachedResultName":"Status de Automa√ß√£o","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1sd1pVo01TwbQ5S00CTl0OPSYse-ZYt-q-xDtQ5ZW8YM/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"Ligado-Desligado","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1sd1pVo01TwbQ5S00CTl0OPSYse-ZYt-q-xDtQ5ZW8YM/edit#gid=0"},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[2992,464],"id":"4a925ca8-d6dc-4641-8d71-efd5fd87e1a0","name":"Verifica Status","credentials":{"googleSheetsOAuth2Api":{"id":"05sHmi34CnrxpGiZ","name":"Google Sheets account"}}},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[3520,592],"id":"dda6a16e-fcc1-40ca-ac52-069db1d4a973","name":"No Operation, do nothing1"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[3904,192],"id":"e818e49e-e9db-4b66-b70e-f4e425bf22be","name":"No Operation, do nothing2"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"230f4e4a-bd4c-4a58-a0cf-5fc3d804bc8c","leftValue":"={{ $('Merge').item.json.texto }}","rightValue":"Ligar","operator":{"type":"string","operation":"contains"}},{"id":"a75beb7a-9528-4ea2-afdf-d57624260a7c","leftValue":"={{ $('Merge').item.json.texto }}","rightValue":"Desligar","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}},{"id":"e03e2912-4443-4350-9e56-dfc32faf3d36","leftValue":"={{ $('Merge').item.json.texto }}","rightValue":"ligar","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}},{"id":"0efbe4ad-3778-409f-9771-595bcc3ed28f","leftValue":"={{ $('Merge').item.json.texto }}","rightValue":"desligar","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"or"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[2560,448],"id":"f45bdb97-e5e6-4f92-8ad0-12d1add11ad2","name":"Est√° ligado?1"},{"parameters":{"resource":"messages-api","instanceName":"Alvorada Digital - Comercial","remoteJid":"={{ $('Webhook').item.json.body.data.key.remoteJid }}","messageText":"=Estou desligado","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[3648,16],"id":"bbebc9fd-7f92-4d6d-b25d-6ac4e7559c60","name":"Desligado1","credentials":{"evolutionApi":{"id":"GH9wowVJvbEs3s5z","name":"Alvorada - Evolution account"}}},{"parameters":{"resource":"messages-api","instanceName":"Alvorada Digital - Comercial","remoteJid":"={{ $('Webhook').item.json.body.data.key.remoteJid }}","messageText":"=Estou ligado","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[3648,192],"id":"935526f0-e306-4b1e-aa98-030b8e621109","name":"Ligado1","credentials":{"evolutionApi":{"id":"GH9wowVJvbEs3s5z","name":"Alvorada - Evolution account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"42db854e-2007-4b66-8223-08d41da1b907","leftValue":"={{ $('Webhook').item.json.body.data.key.remoteJid }}","rightValue":"5511921203010@s.whatsapp.net","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}},{"id":"e20ef496-1007-4b6d-aa17-7a64268d4124","leftValue":"={{ $('Webhook').item.json.body.data.key.remoteJid }}","rightValue":"‚Ä™5511992301618‚Ä¨@s.whatsapp.net","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}},{"id":"fd54f064-f18c-41dc-8e82-4662cb94fab2","leftValue":"={{ $('Webhook').item.json.body.data.key.remoteJid }}","rightValue":"5511959588215@s.whatsapp.net","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}},{"id":"a5913020-f990-444d-82c7-1e0b9e46749a","leftValue":"={{ $('Webhook').item.json.body.data.key.remoteJid }}","rightValue":"5511999916174@s.whatsapp.net","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"or"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[2784,288],"id":"8ca62baa-aafd-4c94-9223-fd183c0968d3","name":"Verifica comando1"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[2992,288],"id":"5323e8d0-04a7-4052-8d69-50ba04817250","name":"No Operation, do nothing4"},{"parameters":{"content":"## Resposta do Agente","height":944,"width":2080},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[4288,96],"id":"bb6713d0-a850-4674-824c-f28dcaf77bd3","name":"Sticky Note"},{"parameters":{"content":"## Tratamento da mensagem","height":896,"width":2416,"color":4},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[80,144],"id":"b359d546-1b00-44e2-9783-e7ef55cd3d18","name":"Sticky Note3"},{"parameters":{"resource":"messages-api","instanceName":"Alvorada Digital - Comercial","remoteJid":"={{ $('Webhook').item.json.body.data.key.remoteJid }}","messageText":"={{ $json.mensagem }}","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[6112,432],"id":"8d661a75-5b19-47c4-8c75-1241dd1cd778","name":"Enviar texto2","credentials":{"evolutionApi":{"id":"GH9wowVJvbEs3s5z","name":"Alvorada - Evolution account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"20fb8045-75ac-431c-b84a-fe0f53efc9d0","leftValue":"={{ $json.body.__submission.user_inputs }}","rightValue":"","operator":{"type":"object","operation":"notEmpty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.3,"position":[-224,560],"id":"0b15d967-cbc2-4089-bccd-e2bd4512b91e","name":"If"},{"parameters":{"content":"## Tratamento de comando - Verifica se o rob√¥ est√° ativo e se √© um lead qualificado","height":1184,"width":1792,"color":5},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[2496,-144],"id":"673f8f18-d673-452b-8404-ca460097b21c","name":"Sticky Note1"},{"parameters":{"content":"## Recebimento da mensagem e filtro de destino","height":336,"width":608},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-528,432],"id":"48f3f39c-3e19-4778-a1f2-6d574d6f71e2","name":"Sticky Note2"},{"parameters":{"content":"## Lead Qualificado Detectado\n","height":800,"width":2416},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[80,-656],"id":"cb82a388-e6e9-4738-a23c-073d8ab92062","name":"Sticky Note4"},{"parameters":{"operation":"formatDate","date":"={{ $('Webhook').item.json.body.__submission.created_at }}","format":"custom","customFormat":"dd-MM-yyyy HH:mm:ss","options":{"timezone":true}},"type":"n8n-nodes-base.dateTime","typeVersion":2,"position":[432,-80],"id":"0c63bfb8-b0b4-4e6d-852c-6a64f216a96d","name":"Date & Time"},{"parameters":{"assignments":{"assignments":[{"id":"401a4fd6-c484-439a-a7c4-5bda70f185a1","name":"Audio","value":"={{ $json.body.data.message.mediaUrl }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[448,576],"id":"745f3bf9-ec5e-43af-a9ad-827e398085dd","name":"Edit Fields3"},{"parameters":{"url":"={{ $json.Audio }}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[672,576],"id":"2c4821db-7774-4d66-a958-bbd62eaa49e5","name":"HTTP Request"},{"parameters":{"operation":"get","tableId":"Lead Qualificado","filters":{"conditions":[{"keyName":"telefone","keyValue":"={{ $('Webhook').item.json.body.data.key.remoteJid.split('@')[0] }}"}]}},"type":"n8n-nodes-base.supabaseTool","typeVersion":1,"position":[4720,672],"id":"a783bb6e-45a6-45d9-bf9c-967738b0fe0d","name":"verifica_numero_cadastrado","credentials":{"supabaseApi":{"id":"OCmrltUrSgbslx3l","name":"Supabase account"}}},{"parameters":{"sessionIdType":"customKey","sessionKey":"={{ $('Webhook').item.json.body.data.key.remoteJid }}","tableName":"=n8n_chat_histories_{{ $('Webhook').item.json.body.data.key.remoteJid.split('@')[0] }}"},"type":"@n8n/n8n-nodes-langchain.memoryPostgresChat","typeVersion":1.3,"position":[4576,672],"id":"5c4422eb-7846-493d-b5ec-85da80328595","name":"Postgres Chat Memory","credentials":{"postgres":{"id":"tV06qWIzMAwRg9qE","name":"Postgres account"}}},{"parameters":{"toolDescription":"Sub-agente de agendamentos do SDR","text":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Prompt__User_Message_', ``, 'string') }}","options":{"systemMessage":"={{ $now.setLocale('pt-BR').toFormat(\"cccc, dd 'de' LLLL 'de' yyyy, HH:mm\") }}\n\nAGENT_IDENTITY {\n  ROLE: \"Gestor de Agenda Google Calendar (Backend)\"\n  MISSION: \"Gerenciar a agenda do Google Calendar (jornadadpp@gmail.com) para o especialista Fernando, cruzando dados com a base Supabase.\"\n  TIMEZONE: \"America/Sao_Paulo\"\n}\n\nINTEGRATIONS_CONTEXT {\n  1. BASE DE LEADS (Supabase - Tabela 'Lead Qualificado'):\n     - Fonte da verdade para Nome, Telefone e E-mail.\n     - Tools: `obterClientes`, `adicionarCliente`.\n  \n  2. AGENDA (Google Calendar):\n     - Sistema de agendamento real.\n     - Tools: `obterAgendamentos`, `adicionarAgendamento`, `removerAgendamento`, `atualizarAgendamento`.\n}\n\nCRITICAL_RULES {\n  1. E-MAIL OBRIGAT√ìRIO: O Google Calendar exige um e-mail para convite (campo 'attendees').\n  2. HOST FIXO: O dono da agenda √© o \"Fernando\" (jornadadpp@gmail.com).\n  3. DATA ISO: Datas sempre em ISO 8601 com fuso -03:00.\n  4. SUGEST√ÉO DUPLA: Se o hor√°rio solicitado estiver ocupado, sugira 2 hor√°rios alternativos pr√≥ximos.\n  5. ID AUTOM√ÅTICO: N√£o tente criar um ID personalizado para o evento. Deixe o Google Calendar gerar automaticamente.\n}\n\nEXECUTION_PIPELINE (Siga estritamente esta ordem)\n\n  STEP 1: RESOLVER O LEAD (Supabase)\n    - A√ß√£o: Use `obterClientes`. Se n√£o achar, use `adicionarCliente`.\n    - Resultado Obrigat√≥rio: Obter o e-mail do lead.\n\n  STEP 2: VERIFICAR DISPONIBILIDADE (Google Calendar)\n    - A√ß√£o: Use `obterAgendamentos`.\n    - Se OCUPADO: Retorne erro JSON com 2 sugest√µes de hor√°rios livres pr√≥ximos.\n\n  STEP 3: CRIAR O EVENTO (Se livre)\n    - A√ß√£o: Use `adicionarAgendamento`.\n    - PREENCHIMENTO OBRIGAT√ìRIO:\n      - `start`: Data/Hora inicial (ISO).\n      - `end`: Data/Hora final (+30 min).\n      - `summary`: \"Sess√£o Estrat√©gica: [Nome do Lead] + Fernando\"\n      - `description`: \"Agendamento via IA.\\nLead: [Nome]\\nTel: [Telefone]\"\n      - `attendees`: [ \"email_do_lead@exemplo.com\" ]\n      - `id`: (DEIXE VAZIO/N√ÉO ENVIE - O Google gera autom√°tico)\n\n  STEP 4: RETORNO JSON\n    - Retorne JSON puro.\n\nOUTPUT_FORMAT (JSON ONLY) {\n  Exemplo Sucesso:\n  {\n    \"ok\": true,\n    \"action\": \"create_appointment\",\n    \"summary\": \"Agendado para 10/10 √†s 14h.\",\n    \"data\": { \"eventId\": \"generated_by_google\" }\n  }\n\n  Exemplo Conflito:\n  {\n    \"ok\": false,\n    \"error\": \"Hor√°rio ocupado. Sugest√µes: 14:30 ou 16:00.\"\n  }\n}","passthroughBinaryImages":true}},"type":"@n8n/n8n-nodes-langchain.agentTool","typeVersion":2.2,"position":[4480,1104],"id":"4c54cf3c-e6ce-4fd8-9a18-b67e954e3121","name":"Agendamentos_SDR"},{"parameters":{"operation":"get","tableId":"Lead Qualificado","filters":{"conditions":[{"keyName":"telefone","keyValue":"={{ $('Webhook').item.json.body.data.key.remoteJid.split('@')[0] }}"}]}},"type":"n8n-nodes-base.supabaseTool","typeVersion":1,"position":[4656,1552],"id":"12f0add5-7e66-4ce6-99b3-1045293e953c","name":"obterClientes","credentials":{"supabaseApi":{"id":"OCmrltUrSgbslx3l","name":"Supabase account"}}},{"parameters":{"model":{"__rl":true,"value":"gpt-4.1-mini","mode":"list","cachedResultName":"gpt-4.1-mini"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[4368,1248],"id":"f9b4e57b-800c-460b-9669-170d34c31f01","name":"gpt-16","credentials":{"openAiApi":{"id":"4QN0fwxyuHPXwljS","name":"OpenAI - Alvorada"}}},{"parameters":{"sessionIdType":"customKey","sessionKey":"={{ $json.body.custom_fields.WhatsApp }}_agendaAGENDAMENTOS2","tableName":"=n8n_chat2_{{ $json.body.custom_fields.WhatsApp }}","contextWindowLength":15},"type":"@n8n/n8n-nodes-langchain.memoryPostgresChat","typeVersion":1.3,"position":[4464,1264],"id":"08801fba-2d8f-4a8d-b245-d1458d56c20e","name":"Postgres_Memory7","credentials":{"postgres":{"id":"tV06qWIzMAwRg9qE","name":"Postgres account"}}},{"parameters":{"tableId":"Lead Qualificado","fieldsUi":{"fieldValues":[{"fieldId":"organization_id","fieldValue":"3d7bd6c6-2373-4fa0-a8bb-22e088efd324"},{"fieldId":"nome","fieldValue":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fieldValues1_Field_Value', ``, 'string') }}"},{"fieldId":"email","fieldValue":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fieldValues2_Field_Value', ``, 'string') }}"},{"fieldId":"telefone","fieldValue":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fieldValues3_Field_Value', ``, 'string') }}"},{"fieldId":"nascimento","fieldValue":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fieldValues4_Field_Value', ``, 'string') }}"},{"fieldId":"documentos","fieldValue":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fieldValues5_Field_Value', ``, 'string') }}"},{"fieldId":"endereco","fieldValue":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fieldValues6_Field_Value', ``, 'string') }}"},{"fieldId":"observacoes","fieldValue":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fieldValues7_Field_Value', ``, 'string') }}"},{"fieldId":"ativo","fieldValue":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fieldValues8_Field_Value', ``, 'string') }}"}]}},"type":"n8n-nodes-base.supabaseTool","typeVersion":1,"position":[4752,1472],"id":"6fb12f8f-7228-4757-bf91-ef68aee08f23","name":"adicionarCliente","credentials":{"supabaseApi":{"id":"OCmrltUrSgbslx3l","name":"Supabase account"}}},{"parameters":{"content":"## Agente de Agendamentos","height":384,"width":800,"color":6},"type":"n8n-nodes-base.stickyNote","position":[4224,1040],"typeVersion":1,"id":"49b9db57-4114-47c5-ba13-81ed7fcf0ffb","name":"Sticky Note6"},{"parameters":{"content":"## Agendamentos da Empresa\nAqui todos os agendamentos da sua Empresa","height":320,"width":1168,"color":5},"type":"n8n-nodes-base.stickyNote","position":[4032,1424],"typeVersion":1,"id":"f6ebc5ef-71bf-429f-afe9-b0a21e20379d","name":"Sticky Note5"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[4096,608],"id":"af82be82-cee7-4f06-bd63-300c53737479","name":"No Operation, do nothing3"},{"parameters":{"operation":"get","tableId":"Lead Qualificado","filters":{"conditions":[{"keyName":"telefone","keyValue":"={{ $('Webhook').item.json.body.data.key.remoteJid.split('@')[0] }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[3616,448],"id":"b275fd0a-ced9-48e4-a59e-a741d73000e6","name":"Busca o usu√°rio","alwaysOutputData":true,"credentials":{"supabaseApi":{"id":"OCmrltUrSgbslx3l","name":"Supabase account"}},"onError":"continueRegularOutput"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"af1b7699-eee0-4141-9f27-c15c9a42f2af","leftValue":"={{ $json.id }}","rightValue":"","operator":{"type":"number","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.3,"position":[3856,448],"id":"5e6b3de5-2a73-40fa-8f86-ca5b0d6fa6af","name":"√â qualificado?"},{"parameters":{"calendar":{"__rl":true,"value":"jornadadpp@gmail.com","mode":"list","cachedResultName":"TIME COMERCIAL"},"start":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Start', `Defina o in√≠cio da reuni√£o`, 'string') }}","end":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('End', `Defina o final da reuni√£o`, 'string') }}","additionalFields":{"attendees":["={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('attendees0_Attendees', `Insira aqui os participantes da call. Um deles deve ser o lead.`, 'string') }}"],"description":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Description', `Insira aqui a descri√ß√£o da reuni√£o`, 'string') }}","summary":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Summary', `Insira o T√≠tulo da Reuni√£o`, 'string') }}"}},"type":"n8n-nodes-base.googleCalendarTool","typeVersion":1.3,"position":[4160,1552],"id":"35af9468-8a1b-4086-a105-badfc9cef4e2","name":"adicionarAgendamento","credentials":{"googleCalendarOAuth2Api":{"id":"ejYJEChlcfb2j30w","name":"Google Calendar account"}}},{"parameters":{"operation":"delete","calendar":{"__rl":true,"value":"jornadadpp@gmail.com","mode":"list","cachedResultName":"TIME COMERCIAL"},"eventId":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Event_ID', ``, 'string') }}","options":{}},"type":"n8n-nodes-base.googleCalendarTool","typeVersion":1.3,"position":[4320,1488],"id":"35784814-e41d-47fc-aa9e-93c63aac1d19","name":"removerAgendamento","credentials":{"googleCalendarOAuth2Api":{"id":"ejYJEChlcfb2j30w","name":"Google Calendar account"}}},{"parameters":{"operation":"get","calendar":{"__rl":true,"value":"jornadadpp@gmail.com","mode":"list","cachedResultName":"TIME COMERCIAL"},"eventId":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Event_ID', ``, 'string') }}","options":{}},"type":"n8n-nodes-base.googleCalendarTool","typeVersion":1.3,"position":[4432,1584],"id":"9685bdc6-578e-41ed-b4ef-6ada27df2f7c","name":"obterAgendamentos","credentials":{"googleCalendarOAuth2Api":{"id":"ejYJEChlcfb2j30w","name":"Google Calendar account"}}},{"parameters":{"operation":"update","calendar":{"__rl":true,"value":"jornadadpp@gmail.com","mode":"list","cachedResultName":"TIME COMERCIAL"},"eventId":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Event_ID', ``, 'string') }}","updateFields":{}},"type":"n8n-nodes-base.googleCalendarTool","typeVersion":1.3,"position":[4528,1472],"id":"a11661d0-2609-4492-9b2a-0315ccc2a732","name":"atualizarAgendamento","credentials":{"googleCalendarOAuth2Api":{"id":"ejYJEChlcfb2j30w","name":"Google Calendar account"}}},{"parameters":{"operation":"update","tableId":"Lead Qualificado","fieldsUi":{"fieldValues":[{"fieldId":"id_meeting","fieldValue":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fieldValues0_Field_Value', `Atualize aqui o id da reuni√£o ap√≥s criada`, 'string') }}"}]}},"type":"n8n-nodes-base.supabaseTool","typeVersion":1,"position":[4896,1504],"id":"1ba7ff7b-573c-45ba-bfbd-1eb76be39b1f","name":"adicionarIDAgendamento","credentials":{"supabaseApi":{"id":"OCmrltUrSgbslx3l","name":"Supabase account"}}},{"parameters":{"operation":"get","tableId":"Lead Qualificado","filters":{"conditions":[{"keyName":"id_meeting","keyValue":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('conditions0_Value', ``, 'string') }}"}]}},"type":"n8n-nodes-base.supabaseTool","typeVersion":1,"position":[5024,1536],"id":"817f3996-b789-40f2-8e0b-e954e318fa28","name":"verificarIDAgendamento","credentials":{"supabaseApi":{"id":"OCmrltUrSgbslx3l","name":"Supabase account"}}},{"parameters":{"action":"generate","dataPropertyName":"ID"},"type":"n8n-nodes-base.crypto","typeVersion":1,"position":[624,-80],"id":"22f97ae1-84b8-45ce-85ea-e361d3499215","name":"uuid"},{"parameters":{"tableId":"Lead Qualificado","fieldsUi":{"fieldValues":[{"fieldId":"uuid","fieldValue":"={{ $json.ID }}"},{"fieldId":"created_at","fieldValue":"={{ $json.formattedDate }}"},{"fieldId":"nome","fieldValue":"={{ $('Edit Fields').item.json.nome }}"},{"fieldId":"telefone","fieldValue":"=55{{ $('Edit Fields').item.json.telefone }}"},{"fieldId":"email","fieldValue":"={{ $('Edit Fields').item.json.email }}"},{"fieldId":"renda","fieldValue":"={{ $('Edit Fields').item.json.renda }}"},{"fieldId":"investimento em tr√°fego","fieldValue":"={{ $('Edit Fields').item.json['investimento em tr√°fego'] }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[816,-80],"id":"71f6fe75-5d22-4392-ac1a-9b6e573ecc4c","name":"criaLead","credentials":{"supabaseApi":{"id":"OCmrltUrSgbslx3l","name":"Supabase account"}}},{"parameters":{"resource":"messages-api","instanceName":"Alvorada Digital - Comercial","remoteJid":"5511999916174@s.whatsapp.net","messageText":"=Fernando, cliente qualificado foi registrado em nossa base. Os dados dele s√£o:\nNome: {{ $('Edit Fields').item.json.nome }}\nTelefone: 55{{ $('Edit Fields').item.json.telefone }}\nRenda: {{ $('Edit Fields').item.json.renda }}\nInvestimento em Tr√°fego: {{ $('Edit Fields').item.json['investimento em tr√°fego'] }}","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[1504,-336],"id":"51f03915-349c-4a82-b057-3a37229f9679","name":"Envia mensagem para a Risolene","credentials":{"evolutionApi":{"id":"GH9wowVJvbEs3s5z","name":"Alvorada - Evolution account"}}},{"parameters":{"amount":15},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[1296,-336],"id":"44e9d12f-823e-4222-9f6c-96d95847c0d4","name":"15 segundos1","webhookId":"b7462df6-cc45-456a-b8a2-e4a71e74ad3d"},{"parameters":{"amount":20},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[1712,-336],"id":"62abf75f-09b6-486d-a50d-fd78c4832609","name":"20 segundos","webhookId":"b7462df6-cc45-456a-b8a2-e4a71e74ad3d"},{"parameters":{"resource":"messages-api","instanceName":"Alvorada Digital - Comercial","remoteJid":"5511921203010@s.whatsapp.net","messageText":"=Fernando, cliente qualificado foi registrado em nossa base. Os dados dele s√£o:\nNome: {{ $('Edit Fields').item.json.nome }}\nTelefone: 55{{ $('Edit Fields').item.json.telefone }}\nRenda: {{ $('Edit Fields').item.json.renda }}\nInvestimento em Tr√°fego: {{ $('Edit Fields').item.json['investimento em tr√°fego'] }}","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[1920,-336],"id":"e24d4f9a-e297-4111-87a8-d5373be532cb","name":"Envia mensagem para o Davi","credentials":{"evolutionApi":{"id":"GH9wowVJvbEs3s5z","name":"Alvorada - Evolution account"}}}],"connections":{"Webhook":{"main":[[{"node":"If","type":"main","index":0}]]},"Edit Fields":{"main":[[{"node":"Envia mensagem para o Aldo","type":"main","index":0},{"node":"Date & Time","type":"main","index":0}]]},"Enviar texto":{"main":[[]]},"10 segundos":{"main":[[{"node":"Envia mensagem para o Ferndando","type":"main","index":0}]]},"Envia mensagem para o Ferndando":{"main":[[{"node":"15 segundos1","type":"main","index":0}]]},"15 segundos":{"main":[[{"node":"Enviar texto","type":"main","index":0}]]},"setTexto":{"main":[[{"node":"Merge","type":"main","index":0}]]},"setImage":{"main":[[{"node":"Analyze image","type":"main","index":0}]]},"Analyze image":{"main":[[{"node":"Edit Fields1","type":"main","index":0}]]},"Edit Fields1":{"main":[[{"node":"Merge","type":"main","index":2}]]},"Merge":{"main":[[{"node":"Est√° ligado?1","type":"main","index":0}]]},"AI Agent":{"main":[[{"node":"Code","type":"main","index":0}]]},"Code":{"main":[[{"node":"Basic LLM Chain2","type":"main","index":0}]]},"Basic LLM Chain2":{"main":[[{"node":"Split Out1","type":"main","index":0}]]},"OpenAI Chat Model5":{"ai_languageModel":[[{"node":"Basic LLM Chain2","type":"ai_languageModel","index":0}]]},"Structured Output Parser2":{"ai_outputParser":[[{"node":"Basic LLM Chain2","type":"ai_outputParser","index":0}]]},"Loop Over Items":{"main":[[],[{"node":"Wait7","type":"main","index":0}]]},"Wait7":{"main":[[{"node":"Enviar texto2","type":"main","index":0}]]},"Split Out1":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"Switch1":{"main":[[{"node":"setTexto","type":"main","index":0}],[{"node":"Edit Fields3","type":"main","index":0}],[{"node":"setImage","type":"main","index":0}]]},"Edit Fields2":{"main":[[{"node":"Merge","type":"main","index":1}]]},"OpenAI Chat Model1":{"ai_languageModel":[[{"node":"AI Agent","type":"ai_languageModel","index":0}]]},"Transcribe a recording":{"main":[[{"node":"Edit Fields2","type":"main","index":0}]]},"Switch":{"main":[[{"node":"Status Desligado","type":"main","index":0}],[{"node":"Status Ligado","type":"main","index":0}],[{"node":"Status Desligado","type":"main","index":0}],[]]},"Status Desligado":{"main":[[{"node":"Desligado","type":"main","index":0}]]},"Status Ligado":{"main":[[{"node":"Ligado","type":"main","index":0}]]},"Desligado":{"main":[[{"node":"Desligado1","type":"main","index":0}]]},"Ligado":{"main":[[{"node":"Ligado1","type":"main","index":0}]]},"Est√° ligado?":{"main":[[{"node":"Busca o usu√°rio","type":"main","index":0}],[{"node":"No Operation, do nothing1","type":"main","index":0}]]},"Verifica Status":{"main":[[{"node":"Est√° ligado?","type":"main","index":0}]]},"Est√° ligado?1":{"main":[[{"node":"Verifica comando1","type":"main","index":0}],[{"node":"Verifica Status","type":"main","index":0}]]},"Desligado1":{"main":[[{"node":"No Operation, do nothing","type":"main","index":0}]]},"Ligado1":{"main":[[{"node":"No Operation, do nothing2","type":"main","index":0}]]},"Verifica comando1":{"main":[[{"node":"Switch","type":"main","index":0}],[{"node":"No Operation, do nothing4","type":"main","index":0}]]},"Enviar texto2":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"If":{"main":[[{"node":"Edit Fields","type":"main","index":0}],[{"node":"Switch1","type":"main","index":0}]]},"Date & Time":{"main":[[{"node":"uuid","type":"main","index":0}]]},"Edit Fields3":{"main":[[{"node":"HTTP Request","type":"main","index":0}]]},"HTTP Request":{"main":[[{"node":"Transcribe a recording","type":"main","index":0}]]},"verifica_numero_cadastrado":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"Postgres Chat Memory":{"ai_memory":[[{"node":"AI Agent","type":"ai_memory","index":0}]]},"Agendamentos_SDR":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"obterClientes":{"ai_tool":[[{"node":"Agendamentos_SDR","type":"ai_tool","index":0}]]},"gpt-16":{"ai_languageModel":[[{"node":"Agendamentos_SDR","type":"ai_languageModel","index":0}]]},"Postgres_Memory7":{"ai_memory":[[{"node":"Agendamentos_SDR","type":"ai_memory","index":0}]]},"adicionarCliente":{"ai_tool":[[{"node":"Agendamentos_SDR","type":"ai_tool","index":0}]]},"Busca o usu√°rio":{"main":[[{"node":"√â qualificado?","type":"main","index":0}]]},"√â qualificado?":{"main":[[{"node":"AI Agent","type":"main","index":0}],[{"node":"No Operation, do nothing3","type":"main","index":0}]]},"Envia mensagem para o Aldo":{"main":[[{"node":"10 segundos","type":"main","index":0}]]},"adicionarAgendamento":{"ai_tool":[[{"node":"Agendamentos_SDR","type":"ai_tool","index":0}]]},"removerAgendamento":{"ai_tool":[[{"node":"Agendamentos_SDR","type":"ai_tool","index":0}]]},"obterAgendamentos":{"ai_tool":[[{"node":"Agendamentos_SDR","type":"ai_tool","index":0}]]},"atualizarAgendamento":{"ai_tool":[[{"node":"Agendamentos_SDR","type":"ai_tool","index":0}]]},"adicionarIDAgendamento":{"ai_tool":[[{"node":"Agendamentos_SDR","type":"ai_tool","index":0}]]},"verificarIDAgendamento":{"ai_tool":[[{"node":"Agendamentos_SDR","type":"ai_tool","index":0}]]},"uuid":{"main":[[{"node":"criaLead","type":"main","index":0}]]},"criaLead":{"main":[[{"node":"15 segundos","type":"main","index":0}]]},"Envia mensagem para a Risolene":{"main":[[{"node":"20 segundos","type":"main","index":0}]]},"15 segundos1":{"main":[[{"node":"Envia mensagem para a Risolene","type":"main","index":0}]]},"20 segundos":{"main":[[{"node":"Envia mensagem para o Davi","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"570304f2-453f-436b-b66b-d38ed08f45e4","activeVersionId":"570304f2-453f-436b-b66b-d38ed08f45e4","triggerCount":1,"shared":[{"updatedAt":"2025-11-03T21:10:54.953Z","createdAt":"2025-11-03T21:10:54.953Z","role":"workflow:owner","workflowId":"af89HGodYaVs3Ame","projectId":"HA3MdmBHnbWmZ1v9"}],"activeVersion":{"updatedAt":"2026-01-12T13:35:00.539Z","createdAt":"2026-01-12T13:34:57.991Z","versionId":"570304f2-453f-436b-b66b-d38ed08f45e4","workflowId":"af89HGodYaVs3Ame","nodes":[{"parameters":{"httpMethod":"POST","path":"QUALIFICADOS","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[-464,528],"id":"85c61de6-3781-4a9c-b3e3-cfa55f6c1338","name":"Webhook","webhookId":"34d9dbc9-d925-40f4-969a-d4fe2b1171bd"},{"parameters":{"assignments":{"assignments":[{"id":"fa38efd0-4ad8-4a31-8df8-a947bd7ebc6c","name":"nome","value":"={{ $json.body.__submission.user_inputs.input_text }}","type":"string"},{"id":"39af9a88-2d20-4366-bd71-2cddea5f5b02","name":"telefone","value":"={{ $json.body.__submission.user_inputs.input_text_1 }}","type":"string"},{"id":"73d9783d-29f6-4cfc-934c-5936118fb521","name":"email","value":"={{ $json.body.__submission.user_inputs.email }}","type":"string"},{"id":"71f198fe-cf86-42b8-a51e-4af44b19837d","name":"renda","value":"={{ $json.body.__submission.user_inputs.input_radio_1 }}","type":"string"},{"id":"d324b14c-691a-417d-a143-6fd60da1a4ac","name":"investimento em tr√°fego","value":"={{ $json.body.__submission.user_inputs.input_radio_2 }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[224,-272],"id":"61def84e-1011-498d-8e14-fd66f2bc6954","name":"Edit Fields"},{"parameters":{"resource":"messages-api","instanceName":"Alvorada Digital - Comercial","remoteJid":"=55{{ $('Edit Fields').item.json.telefone }}@s.whatsapp.net","messageText":"=Grande {{ $('Edit Fields').item.json.nome }}! Tudo bem com voc√™? Voc√™ preencheu o nosso formul√°rio para saber mais sobre o nosso servi√ßo de Lan√ßamento a Pre√ßo Fixo, aqui neste site:  https://jornadadpp.com.br/lancamento_fixo/\n\nPodemos dar continuidade por aqui?","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[1200,-80],"id":"3459432e-5357-41b5-87e9-72810bff9265","name":"Enviar texto","credentials":{"evolutionApi":{"id":"GH9wowVJvbEs3s5z","name":"Alvorada - Evolution account"}}},{"parameters":{"amount":10},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[864,-336],"id":"995ae627-326f-4372-81d0-aec7ef3ad1bf","name":"10 segundos","webhookId":"b7462df6-cc45-456a-b8a2-e4a71e74ad3d"},{"parameters":{"resource":"messages-api","instanceName":"Alvorada Digital - Comercial","remoteJid":"5511999085917@s.whatsapp.net","messageText":"=Aldo, cliente qualificado foi registrado em nossa base. Os dados dele s√£o:\nNome: {{ $('Edit Fields').item.json.nome }}\nTelefone: 55{{ $('Edit Fields').item.json.telefone }}\nRenda: {{ $('Edit Fields').item.json.renda }}\nInvestimento em Tr√°fego: {{ $('Edit Fields').item.json['investimento em tr√°fego'] }}","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[640,-336],"id":"33ff34c5-b2e1-4072-b166-dbe1bda98290","name":"Envia mensagem para o Aldo","credentials":{"evolutionApi":{"id":"GH9wowVJvbEs3s5z","name":"Alvorada - Evolution account"}}},{"parameters":{"resource":"messages-api","instanceName":"Alvorada Digital - Comercial","remoteJid":"5511959588215@s.whatsapp.net","messageText":"=Fernando, cliente qualificado foi registrado em nossa base. Os dados dele s√£o:\nNome: {{ $('Edit Fields').item.json.nome }}\nTelefone: 55{{ $('Edit Fields').item.json.telefone }}\nRenda: {{ $('Edit Fields').item.json.renda }}\nInvestimento em Tr√°fego: {{ $('Edit Fields').item.json['investimento em tr√°fego'] }}","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[1088,-336],"id":"42fb35c3-7eec-48f5-9f7a-4208b6121c94","name":"Envia mensagem para o Ferndando","credentials":{"evolutionApi":{"id":"GH9wowVJvbEs3s5z","name":"Alvorada - Evolution account"}}},{"parameters":{"amount":15},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[1024,-80],"id":"46377eae-91e5-4b4e-ac0b-fc88704d2b8f","name":"15 segundos","webhookId":"b7462df6-cc45-456a-b8a2-e4a71e74ad3d"},{"parameters":{"assignments":{"assignments":[{"id":"a540f4df-31fd-4f1f-8435-258707219724","name":"texto","value":"={{ $json.body.data.message.conversation }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1216,304],"id":"48dead1f-f131-4586-b730-608f67454091","name":"setTexto"},{"parameters":{"assignments":{"assignments":[{"id":"a540f4df-31fd-4f1f-8435-258707219724","name":"image","value":"={{ $('Webhook').item.json.body.data.message.mediaUrl }}","type":"string"},{"id":"05d7a25a-0f52-4769-86a4-5a3fd408a353","name":"legenda","value":"={{ $('Webhook').item.json.body.data.message.imageMessage.caption }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[448,752],"id":"5bf64e4c-f132-41dd-a103-dcb99607ebb3","name":"setImage","onError":"continueRegularOutput"},{"parameters":{"resource":"image","operation":"analyze","modelId":{"__rl":true,"value":"gpt-4o-mini","mode":"list","cachedResultName":"GPT-4O-MINI"},"text":"descreva essa imagem que estou enviando junto com esse comentario para te contextualizar.\nEu trabalho com venda de carros. explique se √© relevante","imageUrls":"={{ $json.image }}","options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[704,752],"id":"bea4f2b8-858f-4a55-885b-68fa9875778b","name":"Analyze image","credentials":{"openAiApi":{"id":"4QN0fwxyuHPXwljS","name":"OpenAI - Alvorada"}}},{"parameters":{"assignments":{"assignments":[{"id":"3806d87c-6c5c-4f60-961c-2eb1ad633319","name":"texto","value":"=Cliente {{ $('Webhook').item.json.body.data.key.remoteJid }} enviou uma imagem com esse conteudo: {{ $json.content }} e esse comentario: {{ $('setImage').item.json.legenda }}\n\n","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1216,768],"id":"06391bba-d1cb-4d67-bc82-22c2c75ed297","name":"Edit Fields1"},{"parameters":{"numberInputs":3},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[2304,432],"id":"14c3ac61-4493-45e4-9456-b4634acd21c9","name":"Merge"},{"parameters":{"promptType":"define","text":"={{ $('Merge').item.json.texto }}","options":{"systemMessage":"=O hor√°rio e data e dia exato de agora √© {{ $now.setLocale('pt-BR').toFormat(\"cccc, dd 'de' LLLL 'de' yyyy, HH:mm\") }} e essa informa√ß√£o est√° atualizada, n√£o h√° necessidade de perguntar o usu√°rio que dia √© hoje.\n\nVoc√™ √© um Agente Comercial altamente humanizado e natural, especializado em acolher leads qualificados da ag√™ncia Alvorada Digital. Voc√™ √© um especialista em SPIN Selling e domina esse processo de vendas de ponta a cabe√ßa.\n\nSeu papel √© entender a necessidade, direcionar e guiar o lead para encontrar a melhor solu√ß√£o para o seu problema atrav√©s dos nossos servi√ßos de Funil Digital, condunzindo at√© a etapa final que √© o agendamento de uma sess√£o estrat√©gica gratuita com o time humano, onde iremos avaliar o caso dele e apresentar solu√ß√µes poss√≠veis. Para saber com quem voc√™ est√° conversando, use a tool verifica_numero_cadastrado (chame s√≥ pelo primeiro nome), nessa tool voc√™ conseguir√° identificar o nome na base do SUPABASE. Se vier nome de empresa, pe√ßa o nome da pessoa com leveza. Se n√£o tiver o cadastro dessa pessoa com nome na function, al√©m do n√∫mero dela, ent√£o pe√ßa o nome da pessoa com leveza.\n\nQuando o lead chegar at√© voc√™, use a tool verifica_numero_cadastrado, busque todas as informa√ß√µes de renda e investimento em tr√°fego que l√° cont√©m. Com isso, voc√™ ir√° desenvolver a conversa com o lead.\n\nS√≥ siga a conversa se o n√∫mero, nome e/ou email de quem est√° solicitando estiver na base a partir da verifica√ß√£o da tool verifica_numero_cadastrado.\n\n\nSeu diferencial: escuta ativa + personaliza√ß√£o com l√≥gica + humaniza√ß√£o com leveza (conversa real, curta e direta).\n\nVoc√™ tem acesso ao Sub-Agente Agente_Agendamentos que te ajuda em agendamentos e gest√£o interna (uso silencioso, invis√≠vel para o lead):\n\n- Agente_Agendamentos: acione-o sempre que precisar adicionar um agendamento, remover um agendamento, atualizar ou consultar agendamentos. Sempre envie para ele o m√°ximo de dados e informa√ß√µes para que ele possa concretizar suas a√ß√µes (nome, telefone, descri√ß√£o, cliente envolvivo, colaborador envolvido, tipo de reuni√£o) -> Se n√£o tiver esses dados ele tem acesso ao banco de consultas de clientes, pe√ßa-o.\n\nPara fazer um agendamento com o lead ele precisa ser registrado como um cliente, e essa a√ß√£o est√° sob responsabilidade do agente de agendamentos tamb√©m, envie todos os dados necess√°rios para que ele registre o cliente tamb√©m.\n\n\nPARAMETROS PARA SUB‚ÄëAGENTES (sempre enviar)\n\n---\n\n### üìû **CAMPOS DE CONTATO** (opcionais):\n\n**id** - Tipo: `int8` - NULLABLE\n- uuid do lead para identifica√ß√£o\n\n**created_at** - Tipo: `timestamptz` - NULLABLE\n- data de cria√ß√£o do lead para controle interno\n\n**email** - Tipo: `text` - NULLABLE\n- E-mail do lead para comunica√ß√£o\n\n**whatsapp** - Tipo: `text` - NULLABLE  \n- N√∫mero do WhatsApp (com DDD/pa√≠s se necess√°rio)\n\n**canal** - Tipo: `text` - NULLABLE\n- Canal de comunica√ß√£o preferido ou atual\n\n**renda** - Tipo: `text` - NULLABLE\n\n**investimento em tr√°fego** - Tipo: `text` - NULLABLE\n\n---\n\n### üìä **CAMPOS DE GEST√ÉO** (opcionais):\n\n**source** - Tipo: `text` - NULLABLE\n- Origem do lead (ex: \"Facebook\", \"Google Ads\", \"Indica√ß√£o\", \"Site\")\n\n**description** - Tipo: `text` - NULLABLE\n- Descri√ß√£o detalhada, observa√ß√µes importantes sobre o lead\n\n**lost_reason** - Tipo: `text` - NULLABLE\n- Motivo da perda (preenchido apenas se lead foi perdido)\n\n**organization_id** - Tipo: `uuid` - NULLABLE\n- ID da organiza√ß√£o (fornecido automaticamente)\n\n**assigned_to** - Tipo: `uuid` - NULLABLE\n- ID do respons√°vel/vendedor atribu√≠do ao lead\n\n**created_by** - Tipo: `uuid` - NULLABLE\n- ID de quem criou o registro\n\n**updated_by** - Tipo: `uuid` - NULLABLE\n- ID de quem fez a √∫ltima atualiza√ß√£o\n\n---\n\n## REGRA‚ÄëM√ÉE: DISCERNIMENTO HUMANO + BASTIDORES INVIS√çVEIS\n- Aja como um atendente humano de verdade.\n- Nunca narre bastidores das opera√ß√µes internas. Pergunte-se: ‚ÄúEu contaria isso pro cliente agora?‚Äù Se n√£o, n√£o fale.\n- Todas as a√ß√µes com agendamentos e integra√ß√µes acontecem de forma silenciosa (o lead nunca v√™).\n- Se precisar confirmar algo, fale de forma humana e direta, sem citar sistemas. Ex.: ‚ÄúBeleza! Voc√™ prefere come√ßar por agendamento ou confirma√ß√µes?‚Äù\n\n## TOM E LINGUAGEM (ATUALIZADO)\n- Tom leve, pr√≥ximo e natural. Contudo, sem informalidade exagerada. Voc√™ n√£o pode usar ‚Äúvc‚Äù, ‚Äúopaaa‚Äù, ‚Äúboraaa‚Äù, ‚Äúuhul‚Äù.\nMas voc√™ pode usar \"show‚Äù, \"querido\", \"legal\" e um ‚Äúkkk‚Äù quando fizer sentido ‚Äî sem exagerar.\n- Frases curtas, ritmo de chat, 1 pergunta por vez.\n- Emojis moderados. Evite informalidade excessiva e jarg√£o esdr√∫xulo com o lead.\n- Personalize usando o primeiro nome sempre que poss√≠vel.\n\nMicro‚Äëexpress√µes √∫teis:\n- ‚ÄúOpa, legal!‚Äù\n- ‚ÄúShow!‚Äù\n- ‚ÄúHahaha, entendi kkk‚Äù\n- ‚ÄúBeleza, posso te fazer uma pergunta r√°pida?‚Äù\n\n## RITMO E PAUSA\n- Evite blocos grandes. Respostas curtas em sequ√™ncia.\n- D√™ tempo pro lead processar. Uma pergunta por vez.\n\n## EVITAR ESTILO ROB√ìTICO\n- N√£o repita f√≥rmulas prontas.\n- Evite formalidade excessiva (‚Äúprezado‚Äù, ‚Äúatenciosamente‚Äù).\n- Evite informalidade excessiva (\"mano\", \"cara\", \"brother\", \"parceiro\"...).\n- Refira-se sempre pelo nome quando poss√≠vel, quando necess√°rio usar vocativos.\n- Evite jarg√£o t√©cnico com o lead.\n\n## CONFIDENCIALIDADE OPERACIONAL\n- Fa√ßa tudo nos sub‚Äëagentes, mas nunca diga: ‚Äúregistrei/atualizei/mudei no CRM‚Äù, ‚Äúkanban‚Äù, ‚Äúintegra√ß√£o‚Äù, ‚Äúsub‚Äëagente‚Äù, ‚Äúcriei agendamento no sistema‚Äù.\n- N√£o √© lista de palavras proibidas ‚Äî √© discernimento. Se soar como bastidor, n√£o fale.\n- Use confirma√ß√µes discretas: ‚ÄúJ√° anotei aqui.‚Äù, ‚ÄúDeixa comigo.‚Äù, ‚ÄúPodemos seguir?‚Äù\n\n## REGRAS DE ESTILO NA RESPOSTA AO LEAD\n- Evite utilizar Markdown com o lead.\n- N√£o use listas com tra√ßos ou n√∫meros.\n- Use quebras de linha apenas quando necess√°rio.\n- Escreva com fluidez de conversa: v√≠rgulas, retic√™ncias, interjei√ß√µes.\n- Uma pergunta por vez. Sem text√£o.\n\n## ORQUESTRA√á√ÉO VIA SUB‚ÄëAGENTES (USO SILENCIOSO) -> Utilize t√©cnica do SPIN Selling para Atuar com o CRM e agendamento em conjunto com essa tecnica.\nVoc√™ n√£o chama tools diretas. Voc√™ chama apenas o Sub‚ÄëAgente:\n- Agente_Agendamentos para cliente, colaborador e compromissos.\nTodas as chamadas s√£o silenciosas. Nunca repasse o retorno textual dos sub‚Äëagentes ao usu√°rio.\n\nQUANDO ACIONAR CADA SUB‚ÄëAGENTE\n- Quando o usu√°rio fornecer e‚Äëmail e hor√°rio propostos, prepare o agendamento com Agente_Agendamentos (silencioso) e siga:\n  1) Verifique/obtenha client_id (obterClientes por email/telefone); se n√£o existir, criar via adicionarCliente.\n  2) O nome do nosso colaborador √© tamb√©m s√≥cio da empresa, √© o Fernando.\n  3) Gere datetime ISO com timezone correto. Nunca duplique hor√°rio.\n  4) Crie o agendamento com adicionarAgendamento (status ‚Äúmarcado‚Äù ou ‚Äúconfirmado‚Äù).\n  5) Atualize o lead para ‚Äúnegociacao‚Äù via Agente_CRM.update_lead e registre a descri√ß√£o com a confirma√ß√£o.\n- Cancelamento: confirme e‚Äëmail, localize o evento (obterAgendamentos) e s√≥ ent√£o removerAgendamento. Nunca pe√ßa ‚ÄúID do evento‚Äù.\n\n## SA√çDA EM CANAL DUPLO (INTERNO)\n- Sempre produza internamente: user_message + agent_calls + memory.\n- Apenas user_message √© vis√≠vel ao lead e nunca deve citar opera√ß√µes internas.\n- agent_calls descreve as chamadas aos sub‚Äëagentes e par√¢metros.\n- memory armazena dados √∫teis para continuidade (m√≠nimo necess√°rio).\n\n## PADR√ÉO DE RETORNO DOS SUB‚ÄëAGENTES (T√âCNICO/JSON)\n- Sub‚Äëagentes retornam somente JSON t√©cnico (sem texto ‚Äúpara usu√°rio‚Äù).\n- Exemplo:\n  { \"ok\": true, \"action\": \"create_appointment\", \"summary\": \"Agendado 2025-08-28T14:00-03:00 c/ Fernando\", \"data\": { ... }, \"error\": null }\n- Em falha:\n  { \"ok\": false, \"action\": \"create_appointment\", \"error\": { \"code\": \"CONFLICT\", \"message\": \"Indispon√≠vel √†s 14:00\" } }\n\n// PATCH 2 ‚Äî Agente Principal (consumir o nudge do CRM)\n## NOVO BLOCO: Tratamento de Nudge do Sub‚ÄëAgente_CRM\n> Sempre que o retorno do Agente_CRM incluir \"nudge.type\" == \"schedule_reminder\":\n> - N√£o mostre nada disso ao lead (bastidores invis√≠veis).\n> - Use imediatamente o lead_id do nudge e o appointment_context para acionar o Agente_Agendamentos.\n> - Siga o fluxo padr√£o: ensure_client ‚Üí find_collaborator ‚Üí create_appointment.\n> - S√≥ diga ‚Äúconvite enviado‚Äù ap√≥s o Agente_Agendamentos retornar ok=true.\n\n[PIPELINE AO RECEBER nudge.schedule_reminder]\n- memory.lead_id = nudge.lead_id (reten√ß√£o sugerida: 72h)\n- agent_calls:\n  1) Agente_Agendamentos.ensure_client({ name, phone: whatsapp_e164 })\n  2) Agente_Agendamentos.find_collaborator({ prefer: collaborator_preference ?? \"Fernando\" })\n  3) Converter proposed_datetime_text ‚Üí ISO (tz: appointment_context.timezone || America/Sao_Paulo)\n  4) Agente_Agendamentos.create_appointment({\n       client_id, collaborator_id, meeting_type,\n       datetime_iso, duration_minutes: 30, status:\"marcado\"\n     })\n  5) Agente_CRM.update_lead({\n       whatsapp, stage:\"negociacao\",\n       description_new:`Agendado ${data_hora_legivel} com ${colaborador}`\n     })\n\n## CHECKLIST A CADA RESPOSTA\n- Antes de afirmar ‚Äúagendamento feito/convite enviado‚Äù ao lead, eu j√° recebi ok=true do Agente_Agendamentos? Se n√£o, n√£o prometa.\n- Fiz o upsert/atualiza√ß√£o do lead quando houve sinal de interesse? Fa√ßa agora (silencioso).\n- Minha mensagem est√° humana e n√£o revela bastidores? Se tiver algo ‚Äúde sistema‚Äù, reescreva antes de enviar.\n- Conflito de hor√°rio? Sugira 1‚Äì2 alternativas pr√≥ximas.\n- Uma pergunta por vez, sem text√£o.\n\n## BASTIDOR‚ÄëCHECK (ANTES DE ENVIAR)\n- Se a mensagem contiver pistas de opera√ß√£o interna (CRM, atualiza√ß√£o de est√°gio, cria√ß√£o/cancelamento t√©cnico, ‚Äúsub‚Äëagente‚Äù, ‚Äúintegra√ß√£o‚Äù, logs), reescreva com linguagem humana e neutra.\n\n## DIRETRIZES DE MODULARIDADE E CONVERSA CONT√çNUA\n- Se precisar explicar algo mais longo:\n  - Divida em partes curtas.\n  - Envie a primeira parte e pergunte se quer continuar.\n  - S√≥ prossiga se o lead sinalizar ‚Äúpode seguir‚Äù.\nEx.: ‚ÄúBeleza, te explico rapidinho‚Ä¶ Primeiro, a gente organiza o agendamento. Quer que eu siga?‚Äù\n\n## √ÅRVORE DE RACIOC√çNIO DO SDR (RESUMO)\nPrinc√≠pios gerais\n- Conversa leve, escuta ativa, humanizada. Uma pergunta por vez.\n- Sempre que houver interesse comercial real, registrar/atualizar no CRM (silencioso).\n- Antes de confirmar hor√°rio, validar e criar via Agente_Agendamentos (silencioso).\n- Nunca pedir ID de evento. Nunca cancelar sem validar e‚Äëmail.\n\nEstados do lead (interno)\n- novo ‚Üí contato ‚Üí negociacao ‚Üí fechado | perdido\n- Mapeamento:\n  - Interesse/demonstra√ß√£o: contato\n  - Agendamento criado: negociacao\n  - Sem fit/desistiu: perdido (com lost_reason)\n  - Fechou: fechado\n\nClassifica√ß√£o inicial no CRM utilizando o SPIN Selling\n- Sauda√ß√£o ‚ÄúOi/Ol√°‚Äù\n  - user_message: acolhe e faz 1 pergunta de diagn√≥stico.\n  - agent_calls: se houver dor no hist√≥rico, upsert (contato).\n- Dor gen√©rica de Tr√°fego/Vendas/Lan√ßamento\n  - user_message: valida e faz 1 pergunta de contexto (roda perp√©tuo ou lan√ßamento? qual o budget? quem cuida do tr√°fego?).\n  - agent_calls: upsert (contato, description com dor e modelo de neg√≥cio).\n- Interesse direto/demonstra√ß√£o\n  - user_message: convida para sess√£o estrat√©gica e pede e‚Äëmail.\n  - agent_calls: upsert (contato).\n- Pedido de pre√ßo\n  - user_message: faixa/abordagem consultiva breve e puxa para sess√£o.\n  - agent_calls: upsert (contato, description ‚ÄúConsultou pre√ßo/taxa‚Äù).\n- Remarca√ß√£o/Cancelamento\n  - user_message: acolhe, confirma e‚Äëmail, pede janela e oferece 2 op√ß√µes.\n  - agent_calls: localizar/alterar/cancelar e atualizar lead (negociacao/perdido) ‚Äî silencioso.\n- Sem fit\n  - user_message: agradece e deixa portas abertas.\n  - agent_calls: update (perdido, lost_reason).\n\n## FLUXO BASE (SPIN Selling + CRM/Agendamentos) ‚Äî Anti-fechamento precoce\n\nPrinc√≠pios do fluxo\n- Uma pergunta por vez, no tom leve (‚Äúvc‚Äù, ‚Äúopaaa‚Äù), sem text√£o.\n- Nunca pule etapas do SPIN. S√≥ proponha sess√£o estrat√©gica depois de Necessidade Expl√≠cita + valor percebido.\n- Evite falar de ‚Äúcomo‚Äù (features). Fa√ßa o lead dizer ‚Äúpor que‚Äù isso importa (benef√≠cios/valor).\n- Bastidores invis√≠veis: qualquer registro/agenda √© silencioso em Sub‚ÄëAgentes.\n- A cada avan√ßo de consci√™ncia, anote no CRM (upsert/notes). S√≥ convide para sess√£o quando houver fit claro.\n\nGatilhos de bloqueio (nunca agendar ainda)\n- Lead sem problema claro OU sem implica√ß√£o relevante OU sem vontade expl√≠cita de resolver agora.\n- Pedido de pre√ßo/agenda nos 2 primeiros turnos sem diagn√≥stico m√≠nimo. Responder com 1‚Äì2 perguntas r√°pidas (SPIN) antes.\n\nEtapas SPIN (com sinais de avan√ßo e CRM)\n\n1) Situa√ß√£o (mapear cen√°rio atual)\n- Objetivo: contexto m√≠nimo para personalizar as pr√≥ximas perguntas.\n- Perguntas (1 por vez):\n  ‚Ä¢ ‚ÄúPra eu entender rapidinho: hoje voc√™ roda mais Lan√ßamento ou Perp√©tuo?‚Äù\n  ‚Ä¢ ‚ÄúQuem cuida do tr√°fego/funil a√≠: voc√™ mesmo, um freela ou ag√™ncia?‚Äù\n  ‚Ä¢ ‚ÄúVolumetria: qual a m√©dia de investimento mensal em ads hoje?‚Äù\n- Sinais de avan√ßo: lead traz dados objetivos (modelo, equipe, budget).\n- Agente_CRM (silencioso): upsert_lead(stage:\"contato\", notes: {modelo, equipe, budget}).\n\n2) Problema (tornar expl√≠citas as dores)\n- Objetivo: transformar inc√¥modos difusos em problemas concretos.\n- Perguntas:\n  ‚Ä¢ ‚ÄúO que mais trava a escala hoje? CPL alto, convers√£o baixa na p√°gina ou falta de previsibilidade?‚Äù\n  ‚Ä¢ ‚ÄúQuando voc√™ tenta escalar o or√ßamento, o ROI despenca?‚Äù\n  ‚Ä¢ ‚ÄúVoc√™ sente que est√° deixando dinheiro na mesa por n√£o ter um funil validado?‚Äù\n- Sinais de avan√ßo: lead assume 1‚Äì2 dores claras (ROI baixo, leads caros, estagna√ß√£o).\n- Agente_CRM: add_note({dores}); tag lead (‚Äúdor: roi-baixo‚Äù, ‚Äúdor: escala‚Äù, ‚Äúdor: lan√ßamento-ca√≥tico‚Äù).\n\n3) Implica√ß√£o (ampliar o impacto/risco)\n- Objetivo: aumentar percep√ß√£o de valor (sem falar da solu√ß√£o).\n- Perguntas:\n  ‚Ä¢ ‚ÄúSe o CPL continuar subindo e a convers√£o n√£o melhorar, como fica a margem do pr√≥ximo lan√ßamento?‚Äù\n  ‚Ä¢ ‚ÄúEssa falta de previsibilidade atrapalha o planejamento financeiro da empresa?‚Äù\n  ‚Ä¢ ‚ÄúSe continuasse assim por 3 meses, qual o risco pro neg√≥cio/caixa?‚Äù\n- Sinais de avan√ßo: lead reconhece consequ√™ncias (preju√≠zo, burnout, estagna√ß√£o, risco de quebrar).\n- Agente_CRM: add_note({implica√ß√µes, impacto_estimado}); se citar n√∫meros, salvar em notes.value_hint.\n\n4) Necessidade de Solu√ß√£o (benef√≠cios ditos pelo lead)\n- Objetivo: fazer o lead verbalizar o que precisa e por que agora.\n- Perguntas:\n  ‚Ä¢ ‚ÄúSe voc√™ tivesse um funil previs√≠vel rodando no azul, o que mudaria na sua rotina?‚Äù\n  ‚Ä¢ ‚ÄúSe a gente estabilizasse o ROAS escalando, qual seria o pr√≥ximo passo da empresa?‚Äù\n  ‚Ä¢ ‚ÄúVale priorizar essa estrutura√ß√£o do funil este m√™s ou deixaria pra depois? Por qu√™?‚Äù\n- Sinais de avan√ßo (Necessidade Expl√≠cita):\n  ‚Ä¢ ‚ÄúQuero escala com lucro‚Äù\n  ‚Ä¢ ‚ÄúPreciso profissionalizar o tr√°fego‚Äù\n  ‚Ä¢ ‚ÄúQuero sair do operacional e ter previsibilidade‚Äù\n- Agente_CRM: update_lead(stage:\"contato\", notes:{necessidades_expl√≠citas, prioridade}); se ‚Äúagora‚Äù, set priority:\"high\".\n\nRegras de sa√≠da da etapa SPIN (s√≥ convide se todas forem verdade)\n- Problema expl√≠cito + Implica√ß√£o reconhecida + Vontade/urg√™ncia de resolver.\n- Lead confirma prioridade neste m√™s e concorda em explorar solu√ß√µes.\n- Fit m√≠nimo: budget para tr√°fego/infoproduto ou servi√ßo validado.\n\nTransi√ß√£o pro convite (sem press√£o; evitar obje√ß√µes)\n- 1) Resumo SPIN (1 linha, linguagem do lead):\n  ‚ÄúShow, [nome]! Pelo que entendi: hoje [problema] t√° travando a escala [impacto], e vc quer [necessidade] pra ontem, certo?‚Äù\n- 2) Checagem de pend√™ncias:\n  ‚ÄúFicou alguma d√∫vida antes da gente dar o pr√≥ximo passo?‚Äù\n- 3) Proposta leve de pr√≥xima a√ß√£o:\n  ‚ÄúBora marcar uma sess√£o estrat√©gica gratuita de 30 min pra desenhar esse funil e te mostrar como a Alvorada resolve isso? Prefere come√ßo ou fim da tarde?‚Äù\n- 4) Coleta t√©cnica m√≠nima:\n  ‚ÄúMe confirma seu melhor e‚Äëmail e 2 janelas de hor√°rio (dia/turno)?‚Äù\n\nOrquestra√ß√£o de Sub‚ÄëAgentes (silencioso)\n- Ao sinal de fit/aceite:\n  1) Agente_CRM.upsert_lead(stage:\"contato\", description:\"Aceitou sess√£o; foco: [dor/objetivo]\").\n  2) Agente_Agendamentos:\n      ‚Ä¢ ensure_client({name, phone: whatsapp_e164, email})\n      ‚Ä¢ find_collaborator({prefer: \"Fernando\" ou dispon√≠vel})\n      ‚Ä¢ toISO(datetime, tz:\"America/Sao_Paulo\")\n      ‚Ä¢ create_appointment({client_id, collaborator_id, meeting_type:\"Sess√£o Estrat√©gica\", datetime_iso, duration:30, status:\"marcado\"})\n  3) Agente_CRM.update_lead(stage:\"negociacao\", description_new:`Agendado ${data_hora_legivel} com ${colaborador}`).\n- S√≥ dizer ao lead ‚Äúconvite enviado‚Äù ap√≥s ok=true do Agente_Agendamentos.\n\nRamos especiais (respostas r√°pidas sem pular SPIN)\n\nA) Pedido direto de pre√ßo\n- Responder:\n  ‚ÄúTe passo uma estimativa j√° j√°, beleza? Pra n√£o te jogar n√∫mero solto: onde d√≥i mais hoje ‚Äî no custo do lead (CPL), na convers√£o ou na falta de tempo pra gerir?‚Äù\n- Ap√≥s 1‚Äì2 respostas, dar faixa orientativa + puxar sess√£o:\n  ‚ÄúGeralmente trabalhamos com [modelo/faixa] conforme o escopo do funil. Melhor desenhar sua estrat√©gia pra cravar e j√° te mostrar o potencial de retorno. Quer sess√£o de 30 min?‚Äù\n\nB) Pedido direto de agendamento (no in√≠cio)\n- Validar com mini‚ÄëSPIN (2 perguntas):\n  ‚ÄúPra direcionar bem: qual o principal gargalo de tr√°fego/vendas hj?‚Äù ‚ÄúSe isso sumisse, o que mudava no faturamento?‚Äù\n- Se houver necessidade expl√≠cita, seguir Transi√ß√£o pro convite. Se n√£o, continuar SPIN.\n\nC) Remarca√ß√£o/Cancelamento\n- ‚ÄúOpa, sem stress! Me fala seu e‚Äëmail e a janela que prefere (2 op√ß√µes) que eu ajeito aqui rapidinho.‚Äù\n- Sub‚ÄëAgente: localizar evento e reagendar/remover; atualizar CRM (negociacao/perdido com lost_reason).\n\nD) Sem fit (sem budget ou nicho n√£o atendido)\n- ‚ÄúAcho que pro seu momento atual n√£o somos a melhor op√ß√£o. Posso te indicar [material gratuito] ou te avisar quando abrirmos vagas para mentorias menores. Fechado?‚Äù\n- CRM: update(stage:\"perdido\", lost_reason).\n\nChecklist por resposta\n- Reconheci e resumi em 1 linha?\n- Fiz 1 pergunta (n√£o duas)?\n- Anotei no CRM o avan√ßo (dor, implica√ß√£o, necessidade, prioridade)?\n- Evitei falar de features; fiz o lead dizer o benef√≠cio?\n- Antes de convidar: passei por Implica√ß√£o + Necessidade Expl√≠cita?\n\nQualifica√ß√£o/tags (CRM)\n- priority: low | medium | high (quando ‚Äúeste m√™s/agora‚Äù ‚Üí high).\n- is_highlight: true (oportunidades estrat√©gicas claras).\n- value: estimativa se o lead trouxe n√∫meros de faturamento/budget; sen√£o null.\n- tags: [\"roi-baixo\", \"escala\", \"lan√ßamento\", \"perp√©tuo\", \"tr√°fego-pago\"].\n\nMicro-exemplos de pergunta (tom leve)\n- ‚ÄúSe o ROAS fosse de 2 para 5, qual seria o efeito no caixa da empresa? rs‚Äù\n- ‚ÄúHoje o que te faz pensar ‚Äòpreciso profissionalizar esse tr√°fego j√°‚Äô?‚Äù\n- ‚ÄúSe o funil rodasse no autom√°tico, sobrava tempo pra qu√™?‚Äù\n\nResumo SPIN (template)\n- ‚ÄúResumo r√°pido: hoje [problema] ‚Üí causa [implica√ß√£o]. Vc quer [necessidade] agora em [prazo]. √â isso? Se sim, bora agendar 30 min pra destravar essa escala?‚Äù\n\nMem√≥ria (curto prazo)\n- Guardar: dores-chave (CPL, ROAS, Convers√£o), impacto/opini√µes, prioridade, disponibilidade, e‚Äëmail. Reten√ß√£o sugerida: at√© 72h p√≥s sess√£o.\n\nAntipadr√µes (evitar)\n- Marcar sess√£o antes de Necessidade Expl√≠cita/valor percebido.\n- Listar funcionalidades (‚Äúfazemos gestao de tr√°fego, copy...‚Äù) ao inv√©s de efeitos.\n- Duas perguntas na mesma mensagem.\n- Prometer ‚Äúmilagre de ROI‚Äù sem entender o escopo m√≠nimo.\n\nKPIs do fluxo\n- % conversas que chegam a Implica√ß√£o.\n- % com Necessidade Expl√≠cita antes do convite.\n- Taxa de aceite do convite (p√≥s-resumo SPIN).\n- Queda de obje√ß√µes (pre√ßo/tempo) ap√≥s adotar SPIN.\n\nObserva√ß√£o final\n- Sempre que houver nudge.schedule_reminder do Agente_CRM, seguir o pipeline padr√£o de agendamento (silencioso) e s√≥ ent√£o avisar ‚Äúconvite enviado‚Äù."}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[4512,432],"id":"c6699219-8a90-4d09-b371-6ee3f7b2fc04","name":"AI Agent"},{"parameters":{"jsCode":"// Supondo que a string original esteja em input\nconst input = $input.item.json.output || \"\";\n\nfunction cleanText(text) {\n  // Remove aspas duplas\n  let cleaned = text.replace(/\"/g, \"\");\n  \n  // Remove pares de asteriscos duplos\n  cleaned = cleaned.replace(/\\*\\*/g, \"\");\n  \n  // Remove par√™nteses que podem quebrar JSON\n  cleaned = cleaned.replace(/[()]/g, \"\");\n  \n  // Remove outros caracteres problem√°ticos para JSON\n  cleaned = cleaned.replace(/[\\[\\]{}]/g, \"\");\n  \n  // Remove caracteres de escape problem√°ticos\n  cleaned = cleaned.replace(/\\\\/g, \"\");\n  \n  // Remove caracteres de controle, exceto quebras de linha\n  cleaned = cleaned.replace(/[\\x00-\\x08\\x0B\\x0C\\x0E-\\x1F\\x7F]/g, \"\");\n  \n  // Remove espa√ßos extras antes e depois da string\n  cleaned = cleaned.trim();\n  \n  // Mant√©m \\n exatamente como est√°, n√£o altera\n  \n  return cleaned;\n}\n\nconst output = cleanText(input);\n\n// Retorna no formato esperado pelo n8n\nreturn [\n  {\n    json: {\n      output: output\n    }\n  }\n];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[4864,432],"id":"51c08941-e5ca-4c14-9214-9b1fc083a0a0","name":"Code"},{"parameters":{"promptType":"define","text":"={{ $json.output }}","hasOutputParser":true,"messages":{"messageValues":[{"message":"sua fun√ß√£o √© dividir o texto recebido em mensagens menores, dividindo por \\n ou pontua√ß√£o. tem um exemplo de json esperado como seu output, mas nunca explique essa regra em seu output ou altere qualquer parte do conte√∫do recebido"}]},"batching":{}},"type":"@n8n/n8n-nodes-langchain.chainLlm","typeVersion":1.7,"position":[5088,432],"id":"fd9d61ba-70e8-4dac-a5c1-e9beb408e3fa","name":"Basic LLM Chain2"},{"parameters":{"model":{"__rl":true,"mode":"list","value":"gpt-4.1-mini"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[5072,672],"id":"e7b48b67-ebf8-45e2-895a-d0418faf0fd5","name":"OpenAI Chat Model5","credentials":{"openAiApi":{"id":"4QN0fwxyuHPXwljS","name":"OpenAI - Alvorada"}}},{"parameters":{"jsonSchemaExample":"{\n\t\"mensagens\": [\n      {\"mensagem\":\"Primeira parte\"},\n      {\"mensagem\":\"Segunda parte\"},\n      {\"mensagem\":\"Parte N\"}\n    ]\n}"},"type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.3,"position":[5264,672],"id":"9e751b54-59f9-4b3d-ac53-876e93682d0e","name":"Structured Output Parser2"},{"parameters":{"options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[5664,432],"id":"d2f898d4-438b-4e82-9e1d-17bdc427d4db","name":"Loop Over Items"},{"parameters":{"amount":3},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[5888,432],"id":"ecafddec-3cdf-4a70-8d89-29d23b37215b","name":"Wait7","webhookId":"afa0a1d9-924e-4e1b-930b-fd2ced50d5c2"},{"parameters":{"fieldToSplitOut":"output.mensagens","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[5440,432],"id":"b8ed9532-929e-481c-b7cf-379349531418","name":"Split Out1"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $('Webhook').item.json.body.data.message.conversation }}","rightValue":"https","operator":{"type":"string","operation":"notEmpty","singleValue":true},"id":"d8ae6bc6-e08a-4bf2-b22a-b8e23edc139a"}],"combinator":"and"},"renameOutput":true,"outputKey":"texto"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"1c33a010-73e3-485b-9d6e-0a7f8c18029a","leftValue":"={{ $('Webhook').item.json.body.data.messageType }}","rightValue":"audio","operator":{"type":"string","operation":"startsWith"}}],"combinator":"and"},"renameOutput":true,"outputKey":"audio"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"218877a5-d12e-4a3d-a036-28e1c200f687","leftValue":"={{ $('Webhook').item.json.body.data.message.imageMessage.mimetype }}","rightValue":"image","operator":{"type":"string","operation":"startsWith"}}],"combinator":"and"},"renameOutput":true,"outputKey":"image"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[176,560],"id":"e131e40c-c5e6-41c9-ac5e-1500ada9737f","name":"Switch1"},{"parameters":{"assignments":{"assignments":[{"id":"18b06c46-0122-451f-85f5-3041efd3bcf3","name":"texto","value":"={{ $json.text }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1216,560],"id":"d28a0e35-8f79-4b0c-a988-1b915034d2fd","name":"Edit Fields2"},{"parameters":{"model":{"__rl":true,"mode":"list","value":"gpt-4.1-mini"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[4432,672],"id":"afb5d479-7aec-4e7c-ac41-d0cbad3df60a","name":"OpenAI Chat Model1","credentials":{"openAiApi":{"id":"4QN0fwxyuHPXwljS","name":"OpenAI - Alvorada"}}},{"parameters":{"resource":"audio","operation":"transcribe","options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[912,576],"id":"58e0cb6b-4336-4920-b53b-b1f18eed9f82","name":"Transcribe a recording","credentials":{"openAiApi":{"id":"4QN0fwxyuHPXwljS","name":"OpenAI - Alvorada"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.texto }}","rightValue":"Desligar","operator":{"type":"string","operation":"equals"},"id":"1b5052ba-fefb-4f1d-a76d-3ee4fa0387c5"}],"combinator":"and"},"renameOutput":true,"outputKey":"Desligar"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"dbd960d0-520a-4ff4-805c-c6a44a7b1905","leftValue":"={{ $json.texto }}","rightValue":"Ligar","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Ligar"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"32df75ca-537e-481a-bfe1-d6a243b54582","leftValue":"={{ $json.texto }}","rightValue":"desligar","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"desligar"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"103707cc-fe19-445e-9efd-f30af9d2cc10","leftValue":"={{ $json.texto }}","rightValue":"ligar","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"ligar"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.3,"position":[3056,112],"id":"66bb2bb6-0021-4069-a57a-01455bacc254","name":"Switch"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[3904,16],"id":"865ef3d8-6976-43c8-9885-86b252f41b18","name":"No Operation, do nothing"},{"parameters":{"assignments":{"assignments":[{"id":"eecc92a6-0b31-4cad-95ac-d4e6c60c69ae","name":"Status","value":"Desligado","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[3264,16],"id":"69199673-55a5-449f-8900-366a02787998","name":"Status Desligado"},{"parameters":{"assignments":{"assignments":[{"id":"bc16506e-7f8a-45e9-b9d4-6412e18a6225","name":"Status","value":"Ligado","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[3248,192],"id":"0b33ff82-8f91-43c2-ba9a-25e6082a1a57","name":"Status Ligado"},{"parameters":{"operation":"update","documentId":{"__rl":true,"value":"1sd1pVo01TwbQ5S00CTl0OPSYse-ZYt-q-xDtQ5ZW8YM","mode":"list","cachedResultName":"Status de Automa√ß√£o","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1sd1pVo01TwbQ5S00CTl0OPSYse-ZYt-q-xDtQ5ZW8YM/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"Ligado-Desligado","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1sd1pVo01TwbQ5S00CTl0OPSYse-ZYt-q-xDtQ5ZW8YM/edit#gid=0"},"columns":{"mappingMode":"defineBelow","value":{"Status":"={{ $json.Status }}","row_number":2},"matchingColumns":["row_number"],"schema":[{"id":"Status","displayName":"Status","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"row_number","displayName":"row_number","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"readOnly":true,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[3440,16],"id":"0a7abf66-3952-48af-a10a-7ad509f8eaae","name":"Desligado","credentials":{"googleSheetsOAuth2Api":{"id":"05sHmi34CnrxpGiZ","name":"Google Sheets account"}}},{"parameters":{"operation":"update","documentId":{"__rl":true,"value":"1sd1pVo01TwbQ5S00CTl0OPSYse-ZYt-q-xDtQ5ZW8YM","mode":"list","cachedResultName":"Status de Automa√ß√£o","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1sd1pVo01TwbQ5S00CTl0OPSYse-ZYt-q-xDtQ5ZW8YM/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"Ligado-Desligado","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1sd1pVo01TwbQ5S00CTl0OPSYse-ZYt-q-xDtQ5ZW8YM/edit#gid=0"},"columns":{"mappingMode":"defineBelow","value":{"row_number":"=2","Status":"={{ $json.Status }}"},"matchingColumns":["row_number"],"schema":[{"id":"Status","displayName":"Status","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"row_number","displayName":"row_number","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"readOnly":true,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[3440,192],"id":"673cc777-4aac-435e-a956-fecaccc8c454","name":"Ligado","credentials":{"googleSheetsOAuth2Api":{"id":"05sHmi34CnrxpGiZ","name":"Google Sheets account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"230f4e4a-bd4c-4a58-a0cf-5fc3d804bc8c","leftValue":"={{ $json.Status }}","rightValue":"Ligado","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[3264,464],"id":"968cec05-9d77-480d-ac4f-cccc828fcfbd","name":"Est√° ligado?"},{"parameters":{"documentId":{"__rl":true,"value":"1sd1pVo01TwbQ5S00CTl0OPSYse-ZYt-q-xDtQ5ZW8YM","mode":"list","cachedResultName":"Status de Automa√ß√£o","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1sd1pVo01TwbQ5S00CTl0OPSYse-ZYt-q-xDtQ5ZW8YM/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"Ligado-Desligado","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1sd1pVo01TwbQ5S00CTl0OPSYse-ZYt-q-xDtQ5ZW8YM/edit#gid=0"},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.7,"position":[2992,464],"id":"4a925ca8-d6dc-4641-8d71-efd5fd87e1a0","name":"Verifica Status","credentials":{"googleSheetsOAuth2Api":{"id":"05sHmi34CnrxpGiZ","name":"Google Sheets account"}}},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[3520,592],"id":"dda6a16e-fcc1-40ca-ac52-069db1d4a973","name":"No Operation, do nothing1"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[3904,192],"id":"e818e49e-e9db-4b66-b70e-f4e425bf22be","name":"No Operation, do nothing2"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"230f4e4a-bd4c-4a58-a0cf-5fc3d804bc8c","leftValue":"={{ $('Merge').item.json.texto }}","rightValue":"Ligar","operator":{"type":"string","operation":"contains"}},{"id":"a75beb7a-9528-4ea2-afdf-d57624260a7c","leftValue":"={{ $('Merge').item.json.texto }}","rightValue":"Desligar","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}},{"id":"e03e2912-4443-4350-9e56-dfc32faf3d36","leftValue":"={{ $('Merge').item.json.texto }}","rightValue":"ligar","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}},{"id":"0efbe4ad-3778-409f-9771-595bcc3ed28f","leftValue":"={{ $('Merge').item.json.texto }}","rightValue":"desligar","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"or"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[2560,448],"id":"f45bdb97-e5e6-4f92-8ad0-12d1add11ad2","name":"Est√° ligado?1"},{"parameters":{"resource":"messages-api","instanceName":"Alvorada Digital - Comercial","remoteJid":"={{ $('Webhook').item.json.body.data.key.remoteJid }}","messageText":"=Estou desligado","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[3648,16],"id":"bbebc9fd-7f92-4d6d-b25d-6ac4e7559c60","name":"Desligado1","credentials":{"evolutionApi":{"id":"GH9wowVJvbEs3s5z","name":"Alvorada - Evolution account"}}},{"parameters":{"resource":"messages-api","instanceName":"Alvorada Digital - Comercial","remoteJid":"={{ $('Webhook').item.json.body.data.key.remoteJid }}","messageText":"=Estou ligado","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[3648,192],"id":"935526f0-e306-4b1e-aa98-030b8e621109","name":"Ligado1","credentials":{"evolutionApi":{"id":"GH9wowVJvbEs3s5z","name":"Alvorada - Evolution account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"42db854e-2007-4b66-8223-08d41da1b907","leftValue":"={{ $('Webhook').item.json.body.data.key.remoteJid }}","rightValue":"5511921203010@s.whatsapp.net","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}},{"id":"e20ef496-1007-4b6d-aa17-7a64268d4124","leftValue":"={{ $('Webhook').item.json.body.data.key.remoteJid }}","rightValue":"‚Ä™5511992301618‚Ä¨@s.whatsapp.net","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}},{"id":"fd54f064-f18c-41dc-8e82-4662cb94fab2","leftValue":"={{ $('Webhook').item.json.body.data.key.remoteJid }}","rightValue":"5511959588215@s.whatsapp.net","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}},{"id":"a5913020-f990-444d-82c7-1e0b9e46749a","leftValue":"={{ $('Webhook').item.json.body.data.key.remoteJid }}","rightValue":"5511999916174@s.whatsapp.net","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"or"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[2784,288],"id":"8ca62baa-aafd-4c94-9223-fd183c0968d3","name":"Verifica comando1"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[2992,288],"id":"5323e8d0-04a7-4052-8d69-50ba04817250","name":"No Operation, do nothing4"},{"parameters":{"content":"## Resposta do Agente","height":944,"width":2080},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[4288,96],"id":"bb6713d0-a850-4674-824c-f28dcaf77bd3","name":"Sticky Note"},{"parameters":{"content":"## Tratamento da mensagem","height":896,"width":2416,"color":4},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[80,144],"id":"b359d546-1b00-44e2-9783-e7ef55cd3d18","name":"Sticky Note3"},{"parameters":{"resource":"messages-api","instanceName":"Alvorada Digital - Comercial","remoteJid":"={{ $('Webhook').item.json.body.data.key.remoteJid }}","messageText":"={{ $json.mensagem }}","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[6112,432],"id":"8d661a75-5b19-47c4-8c75-1241dd1cd778","name":"Enviar texto2","credentials":{"evolutionApi":{"id":"GH9wowVJvbEs3s5z","name":"Alvorada - Evolution account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"20fb8045-75ac-431c-b84a-fe0f53efc9d0","leftValue":"={{ $json.body.__submission.user_inputs }}","rightValue":"","operator":{"type":"object","operation":"notEmpty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.3,"position":[-224,560],"id":"0b15d967-cbc2-4089-bccd-e2bd4512b91e","name":"If"},{"parameters":{"content":"## Tratamento de comando - Verifica se o rob√¥ est√° ativo e se √© um lead qualificado","height":1184,"width":1792,"color":5},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[2496,-144],"id":"673f8f18-d673-452b-8404-ca460097b21c","name":"Sticky Note1"},{"parameters":{"content":"## Recebimento da mensagem e filtro de destino","height":336,"width":608},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-528,432],"id":"48f3f39c-3e19-4778-a1f2-6d574d6f71e2","name":"Sticky Note2"},{"parameters":{"content":"## Lead Qualificado Detectado\n","height":800,"width":2416},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[80,-656],"id":"cb82a388-e6e9-4738-a23c-073d8ab92062","name":"Sticky Note4"},{"parameters":{"operation":"formatDate","date":"={{ $('Webhook').item.json.body.__submission.created_at }}","format":"custom","customFormat":"dd-MM-yyyy HH:mm:ss","options":{"timezone":true}},"type":"n8n-nodes-base.dateTime","typeVersion":2,"position":[432,-80],"id":"0c63bfb8-b0b4-4e6d-852c-6a64f216a96d","name":"Date & Time"},{"parameters":{"assignments":{"assignments":[{"id":"401a4fd6-c484-439a-a7c4-5bda70f185a1","name":"Audio","value":"={{ $json.body.data.message.mediaUrl }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[448,576],"id":"745f3bf9-ec5e-43af-a9ad-827e398085dd","name":"Edit Fields3"},{"parameters":{"url":"={{ $json.Audio }}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.3,"position":[672,576],"id":"2c4821db-7774-4d66-a958-bbd62eaa49e5","name":"HTTP Request"},{"parameters":{"operation":"get","tableId":"Lead Qualificado","filters":{"conditions":[{"keyName":"telefone","keyValue":"={{ $('Webhook').item.json.body.data.key.remoteJid.split('@')[0] }}"}]}},"type":"n8n-nodes-base.supabaseTool","typeVersion":1,"position":[4720,672],"id":"a783bb6e-45a6-45d9-bf9c-967738b0fe0d","name":"verifica_numero_cadastrado","credentials":{"supabaseApi":{"id":"OCmrltUrSgbslx3l","name":"Supabase account"}}},{"parameters":{"sessionIdType":"customKey","sessionKey":"={{ $('Webhook').item.json.body.data.key.remoteJid }}","tableName":"=n8n_chat_histories_{{ $('Webhook').item.json.body.data.key.remoteJid.split('@')[0] }}"},"type":"@n8n/n8n-nodes-langchain.memoryPostgresChat","typeVersion":1.3,"position":[4576,672],"id":"5c4422eb-7846-493d-b5ec-85da80328595","name":"Postgres Chat Memory","credentials":{"postgres":{"id":"tV06qWIzMAwRg9qE","name":"Postgres account"}}},{"parameters":{"toolDescription":"Sub-agente de agendamentos do SDR","text":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Prompt__User_Message_', ``, 'string') }}","options":{"systemMessage":"={{ $now.setLocale('pt-BR').toFormat(\"cccc, dd 'de' LLLL 'de' yyyy, HH:mm\") }}\n\nAGENT_IDENTITY {\n  ROLE: \"Gestor de Agenda Google Calendar (Backend)\"\n  MISSION: \"Gerenciar a agenda do Google Calendar (jornadadpp@gmail.com) para o especialista Fernando, cruzando dados com a base Supabase.\"\n  TIMEZONE: \"America/Sao_Paulo\"\n}\n\nINTEGRATIONS_CONTEXT {\n  1. BASE DE LEADS (Supabase - Tabela 'Lead Qualificado'):\n     - Fonte da verdade para Nome, Telefone e E-mail.\n     - Tools: `obterClientes`, `adicionarCliente`.\n  \n  2. AGENDA (Google Calendar):\n     - Sistema de agendamento real.\n     - Tools: `obterAgendamentos`, `adicionarAgendamento`, `removerAgendamento`, `atualizarAgendamento`.\n}\n\nCRITICAL_RULES {\n  1. E-MAIL OBRIGAT√ìRIO: O Google Calendar exige um e-mail para convite (campo 'attendees').\n  2. HOST FIXO: O dono da agenda √© o \"Fernando\" (jornadadpp@gmail.com).\n  3. DATA ISO: Datas sempre em ISO 8601 com fuso -03:00.\n  4. SUGEST√ÉO DUPLA: Se o hor√°rio solicitado estiver ocupado, sugira 2 hor√°rios alternativos pr√≥ximos.\n  5. ID AUTOM√ÅTICO: N√£o tente criar um ID personalizado para o evento. Deixe o Google Calendar gerar automaticamente.\n}\n\nEXECUTION_PIPELINE (Siga estritamente esta ordem)\n\n  STEP 1: RESOLVER O LEAD (Supabase)\n    - A√ß√£o: Use `obterClientes`. Se n√£o achar, use `adicionarCliente`.\n    - Resultado Obrigat√≥rio: Obter o e-mail do lead.\n\n  STEP 2: VERIFICAR DISPONIBILIDADE (Google Calendar)\n    - A√ß√£o: Use `obterAgendamentos`.\n    - Se OCUPADO: Retorne erro JSON com 2 sugest√µes de hor√°rios livres pr√≥ximos.\n\n  STEP 3: CRIAR O EVENTO (Se livre)\n    - A√ß√£o: Use `adicionarAgendamento`.\n    - PREENCHIMENTO OBRIGAT√ìRIO:\n      - `start`: Data/Hora inicial (ISO).\n      - `end`: Data/Hora final (+30 min).\n      - `summary`: \"Sess√£o Estrat√©gica: [Nome do Lead] + Fernando\"\n      - `description`: \"Agendamento via IA.\\nLead: [Nome]\\nTel: [Telefone]\"\n      - `attendees`: [ \"email_do_lead@exemplo.com\" ]\n      - `id`: (DEIXE VAZIO/N√ÉO ENVIE - O Google gera autom√°tico)\n\n  STEP 4: RETORNO JSON\n    - Retorne JSON puro.\n\nOUTPUT_FORMAT (JSON ONLY) {\n  Exemplo Sucesso:\n  {\n    \"ok\": true,\n    \"action\": \"create_appointment\",\n    \"summary\": \"Agendado para 10/10 √†s 14h.\",\n    \"data\": { \"eventId\": \"generated_by_google\" }\n  }\n\n  Exemplo Conflito:\n  {\n    \"ok\": false,\n    \"error\": \"Hor√°rio ocupado. Sugest√µes: 14:30 ou 16:00.\"\n  }\n}","passthroughBinaryImages":true}},"type":"@n8n/n8n-nodes-langchain.agentTool","typeVersion":2.2,"position":[4480,1104],"id":"4c54cf3c-e6ce-4fd8-9a18-b67e954e3121","name":"Agendamentos_SDR"},{"parameters":{"operation":"get","tableId":"Lead Qualificado","filters":{"conditions":[{"keyName":"telefone","keyValue":"={{ $('Webhook').item.json.body.data.key.remoteJid.split('@')[0] }}"}]}},"type":"n8n-nodes-base.supabaseTool","typeVersion":1,"position":[4656,1552],"id":"12f0add5-7e66-4ce6-99b3-1045293e953c","name":"obterClientes","credentials":{"supabaseApi":{"id":"OCmrltUrSgbslx3l","name":"Supabase account"}}},{"parameters":{"model":{"__rl":true,"value":"gpt-4.1-mini","mode":"list","cachedResultName":"gpt-4.1-mini"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[4368,1248],"id":"f9b4e57b-800c-460b-9669-170d34c31f01","name":"gpt-16","credentials":{"openAiApi":{"id":"4QN0fwxyuHPXwljS","name":"OpenAI - Alvorada"}}},{"parameters":{"sessionIdType":"customKey","sessionKey":"={{ $json.body.custom_fields.WhatsApp }}_agendaAGENDAMENTOS2","tableName":"=n8n_chat2_{{ $json.body.custom_fields.WhatsApp }}","contextWindowLength":15},"type":"@n8n/n8n-nodes-langchain.memoryPostgresChat","typeVersion":1.3,"position":[4464,1264],"id":"08801fba-2d8f-4a8d-b245-d1458d56c20e","name":"Postgres_Memory7","credentials":{"postgres":{"id":"tV06qWIzMAwRg9qE","name":"Postgres account"}}},{"parameters":{"tableId":"Lead Qualificado","fieldsUi":{"fieldValues":[{"fieldId":"organization_id","fieldValue":"3d7bd6c6-2373-4fa0-a8bb-22e088efd324"},{"fieldId":"nome","fieldValue":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fieldValues1_Field_Value', ``, 'string') }}"},{"fieldId":"email","fieldValue":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fieldValues2_Field_Value', ``, 'string') }}"},{"fieldId":"telefone","fieldValue":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fieldValues3_Field_Value', ``, 'string') }}"},{"fieldId":"nascimento","fieldValue":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fieldValues4_Field_Value', ``, 'string') }}"},{"fieldId":"documentos","fieldValue":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fieldValues5_Field_Value', ``, 'string') }}"},{"fieldId":"endereco","fieldValue":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fieldValues6_Field_Value', ``, 'string') }}"},{"fieldId":"observacoes","fieldValue":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fieldValues7_Field_Value', ``, 'string') }}"},{"fieldId":"ativo","fieldValue":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fieldValues8_Field_Value', ``, 'string') }}"}]}},"type":"n8n-nodes-base.supabaseTool","typeVersion":1,"position":[4752,1472],"id":"6fb12f8f-7228-4757-bf91-ef68aee08f23","name":"adicionarCliente","credentials":{"supabaseApi":{"id":"OCmrltUrSgbslx3l","name":"Supabase account"}}},{"parameters":{"content":"## Agente de Agendamentos","height":384,"width":800,"color":6},"type":"n8n-nodes-base.stickyNote","position":[4224,1040],"typeVersion":1,"id":"49b9db57-4114-47c5-ba13-81ed7fcf0ffb","name":"Sticky Note6"},{"parameters":{"content":"## Agendamentos da Empresa\nAqui todos os agendamentos da sua Empresa","height":320,"width":1168,"color":5},"type":"n8n-nodes-base.stickyNote","position":[4032,1424],"typeVersion":1,"id":"f6ebc5ef-71bf-429f-afe9-b0a21e20379d","name":"Sticky Note5"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[4096,608],"id":"af82be82-cee7-4f06-bd63-300c53737479","name":"No Operation, do nothing3"},{"parameters":{"operation":"get","tableId":"Lead Qualificado","filters":{"conditions":[{"keyName":"telefone","keyValue":"={{ $('Webhook').item.json.body.data.key.remoteJid.split('@')[0] }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[3616,448],"id":"b275fd0a-ced9-48e4-a59e-a741d73000e6","name":"Busca o usu√°rio","alwaysOutputData":true,"credentials":{"supabaseApi":{"id":"OCmrltUrSgbslx3l","name":"Supabase account"}},"onError":"continueRegularOutput"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":3},"conditions":[{"id":"af1b7699-eee0-4141-9f27-c15c9a42f2af","leftValue":"={{ $json.id }}","rightValue":"","operator":{"type":"number","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.3,"position":[3856,448],"id":"5e6b3de5-2a73-40fa-8f86-ca5b0d6fa6af","name":"√â qualificado?"},{"parameters":{"calendar":{"__rl":true,"value":"jornadadpp@gmail.com","mode":"list","cachedResultName":"TIME COMERCIAL"},"start":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Start', `Defina o in√≠cio da reuni√£o`, 'string') }}","end":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('End', `Defina o final da reuni√£o`, 'string') }}","additionalFields":{"attendees":["={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('attendees0_Attendees', `Insira aqui os participantes da call. Um deles deve ser o lead.`, 'string') }}"],"description":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Description', `Insira aqui a descri√ß√£o da reuni√£o`, 'string') }}","summary":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Summary', `Insira o T√≠tulo da Reuni√£o`, 'string') }}"}},"type":"n8n-nodes-base.googleCalendarTool","typeVersion":1.3,"position":[4160,1552],"id":"35af9468-8a1b-4086-a105-badfc9cef4e2","name":"adicionarAgendamento","credentials":{"googleCalendarOAuth2Api":{"id":"ejYJEChlcfb2j30w","name":"Google Calendar account"}}},{"parameters":{"operation":"delete","calendar":{"__rl":true,"value":"jornadadpp@gmail.com","mode":"list","cachedResultName":"TIME COMERCIAL"},"eventId":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Event_ID', ``, 'string') }}","options":{}},"type":"n8n-nodes-base.googleCalendarTool","typeVersion":1.3,"position":[4320,1488],"id":"35784814-e41d-47fc-aa9e-93c63aac1d19","name":"removerAgendamento","credentials":{"googleCalendarOAuth2Api":{"id":"ejYJEChlcfb2j30w","name":"Google Calendar account"}}},{"parameters":{"operation":"get","calendar":{"__rl":true,"value":"jornadadpp@gmail.com","mode":"list","cachedResultName":"TIME COMERCIAL"},"eventId":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Event_ID', ``, 'string') }}","options":{}},"type":"n8n-nodes-base.googleCalendarTool","typeVersion":1.3,"position":[4432,1584],"id":"9685bdc6-578e-41ed-b4ef-6ada27df2f7c","name":"obterAgendamentos","credentials":{"googleCalendarOAuth2Api":{"id":"ejYJEChlcfb2j30w","name":"Google Calendar account"}}},{"parameters":{"operation":"update","calendar":{"__rl":true,"value":"jornadadpp@gmail.com","mode":"list","cachedResultName":"TIME COMERCIAL"},"eventId":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Event_ID', ``, 'string') }}","updateFields":{}},"type":"n8n-nodes-base.googleCalendarTool","typeVersion":1.3,"position":[4528,1472],"id":"a11661d0-2609-4492-9b2a-0315ccc2a732","name":"atualizarAgendamento","credentials":{"googleCalendarOAuth2Api":{"id":"ejYJEChlcfb2j30w","name":"Google Calendar account"}}},{"parameters":{"operation":"update","tableId":"Lead Qualificado","fieldsUi":{"fieldValues":[{"fieldId":"id_meeting","fieldValue":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fieldValues0_Field_Value', `Atualize aqui o id da reuni√£o ap√≥s criada`, 'string') }}"}]}},"type":"n8n-nodes-base.supabaseTool","typeVersion":1,"position":[4896,1504],"id":"1ba7ff7b-573c-45ba-bfbd-1eb76be39b1f","name":"adicionarIDAgendamento","credentials":{"supabaseApi":{"id":"OCmrltUrSgbslx3l","name":"Supabase account"}}},{"parameters":{"operation":"get","tableId":"Lead Qualificado","filters":{"conditions":[{"keyName":"id_meeting","keyValue":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('conditions0_Value', ``, 'string') }}"}]}},"type":"n8n-nodes-base.supabaseTool","typeVersion":1,"position":[5024,1536],"id":"817f3996-b789-40f2-8e0b-e954e318fa28","name":"verificarIDAgendamento","credentials":{"supabaseApi":{"id":"OCmrltUrSgbslx3l","name":"Supabase account"}}},{"parameters":{"action":"generate","dataPropertyName":"ID"},"type":"n8n-nodes-base.crypto","typeVersion":1,"position":[624,-80],"id":"22f97ae1-84b8-45ce-85ea-e361d3499215","name":"uuid"},{"parameters":{"tableId":"Lead Qualificado","fieldsUi":{"fieldValues":[{"fieldId":"uuid","fieldValue":"={{ $json.ID }}"},{"fieldId":"created_at","fieldValue":"={{ $json.formattedDate }}"},{"fieldId":"nome","fieldValue":"={{ $('Edit Fields').item.json.nome }}"},{"fieldId":"telefone","fieldValue":"=55{{ $('Edit Fields').item.json.telefone }}"},{"fieldId":"email","fieldValue":"={{ $('Edit Fields').item.json.email }}"},{"fieldId":"renda","fieldValue":"={{ $('Edit Fields').item.json.renda }}"},{"fieldId":"investimento em tr√°fego","fieldValue":"={{ $('Edit Fields').item.json['investimento em tr√°fego'] }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[816,-80],"id":"71f6fe75-5d22-4392-ac1a-9b6e573ecc4c","name":"criaLead","credentials":{"supabaseApi":{"id":"OCmrltUrSgbslx3l","name":"Supabase account"}}},{"parameters":{"resource":"messages-api","instanceName":"Alvorada Digital - Comercial","remoteJid":"5511999916174@s.whatsapp.net","messageText":"=Fernando, cliente qualificado foi registrado em nossa base. Os dados dele s√£o:\nNome: {{ $('Edit Fields').item.json.nome }}\nTelefone: 55{{ $('Edit Fields').item.json.telefone }}\nRenda: {{ $('Edit Fields').item.json.renda }}\nInvestimento em Tr√°fego: {{ $('Edit Fields').item.json['investimento em tr√°fego'] }}","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[1504,-336],"id":"51f03915-349c-4a82-b057-3a37229f9679","name":"Envia mensagem para a Risolene","credentials":{"evolutionApi":{"id":"GH9wowVJvbEs3s5z","name":"Alvorada - Evolution account"}}},{"parameters":{"amount":15},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[1296,-336],"id":"44e9d12f-823e-4222-9f6c-96d95847c0d4","name":"15 segundos1","webhookId":"b7462df6-cc45-456a-b8a2-e4a71e74ad3d"},{"parameters":{"amount":20},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[1712,-336],"id":"62abf75f-09b6-486d-a50d-fd78c4832609","name":"20 segundos","webhookId":"b7462df6-cc45-456a-b8a2-e4a71e74ad3d"},{"parameters":{"resource":"messages-api","instanceName":"Alvorada Digital - Comercial","remoteJid":"5511921203010@s.whatsapp.net","messageText":"=Fernando, cliente qualificado foi registrado em nossa base. Os dados dele s√£o:\nNome: {{ $('Edit Fields').item.json.nome }}\nTelefone: 55{{ $('Edit Fields').item.json.telefone }}\nRenda: {{ $('Edit Fields').item.json.renda }}\nInvestimento em Tr√°fego: {{ $('Edit Fields').item.json['investimento em tr√°fego'] }}","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[1920,-336],"id":"e24d4f9a-e297-4111-87a8-d5373be532cb","name":"Envia mensagem para o Davi","credentials":{"evolutionApi":{"id":"GH9wowVJvbEs3s5z","name":"Alvorada - Evolution account"}}}],"connections":{"Webhook":{"main":[[{"node":"If","type":"main","index":0}]]},"Edit Fields":{"main":[[{"node":"Envia mensagem para o Aldo","type":"main","index":0},{"node":"Date & Time","type":"main","index":0}]]},"Enviar texto":{"main":[[]]},"10 segundos":{"main":[[{"node":"Envia mensagem para o Ferndando","type":"main","index":0}]]},"Envia mensagem para o Ferndando":{"main":[[{"node":"15 segundos1","type":"main","index":0}]]},"15 segundos":{"main":[[{"node":"Enviar texto","type":"main","index":0}]]},"setTexto":{"main":[[{"node":"Merge","type":"main","index":0}]]},"setImage":{"main":[[{"node":"Analyze image","type":"main","index":0}]]},"Analyze image":{"main":[[{"node":"Edit Fields1","type":"main","index":0}]]},"Edit Fields1":{"main":[[{"node":"Merge","type":"main","index":2}]]},"Merge":{"main":[[{"node":"Est√° ligado?1","type":"main","index":0}]]},"AI Agent":{"main":[[{"node":"Code","type":"main","index":0}]]},"Code":{"main":[[{"node":"Basic LLM Chain2","type":"main","index":0}]]},"Basic LLM Chain2":{"main":[[{"node":"Split Out1","type":"main","index":0}]]},"OpenAI Chat Model5":{"ai_languageModel":[[{"node":"Basic LLM Chain2","type":"ai_languageModel","index":0}]]},"Structured Output Parser2":{"ai_outputParser":[[{"node":"Basic LLM Chain2","type":"ai_outputParser","index":0}]]},"Loop Over Items":{"main":[[],[{"node":"Wait7","type":"main","index":0}]]},"Wait7":{"main":[[{"node":"Enviar texto2","type":"main","index":0}]]},"Split Out1":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"Switch1":{"main":[[{"node":"setTexto","type":"main","index":0}],[{"node":"Edit Fields3","type":"main","index":0}],[{"node":"setImage","type":"main","index":0}]]},"Edit Fields2":{"main":[[{"node":"Merge","type":"main","index":1}]]},"OpenAI Chat Model1":{"ai_languageModel":[[{"node":"AI Agent","type":"ai_languageModel","index":0}]]},"Transcribe a recording":{"main":[[{"node":"Edit Fields2","type":"main","index":0}]]},"Switch":{"main":[[{"node":"Status Desligado","type":"main","index":0}],[{"node":"Status Ligado","type":"main","index":0}],[{"node":"Status Desligado","type":"main","index":0}],[]]},"Status Desligado":{"main":[[{"node":"Desligado","type":"main","index":0}]]},"Status Ligado":{"main":[[{"node":"Ligado","type":"main","index":0}]]},"Desligado":{"main":[[{"node":"Desligado1","type":"main","index":0}]]},"Ligado":{"main":[[{"node":"Ligado1","type":"main","index":0}]]},"Est√° ligado?":{"main":[[{"node":"Busca o usu√°rio","type":"main","index":0}],[{"node":"No Operation, do nothing1","type":"main","index":0}]]},"Verifica Status":{"main":[[{"node":"Est√° ligado?","type":"main","index":0}]]},"Est√° ligado?1":{"main":[[{"node":"Verifica comando1","type":"main","index":0}],[{"node":"Verifica Status","type":"main","index":0}]]},"Desligado1":{"main":[[{"node":"No Operation, do nothing","type":"main","index":0}]]},"Ligado1":{"main":[[{"node":"No Operation, do nothing2","type":"main","index":0}]]},"Verifica comando1":{"main":[[{"node":"Switch","type":"main","index":0}],[{"node":"No Operation, do nothing4","type":"main","index":0}]]},"Enviar texto2":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"If":{"main":[[{"node":"Edit Fields","type":"main","index":0}],[{"node":"Switch1","type":"main","index":0}]]},"Date & Time":{"main":[[{"node":"uuid","type":"main","index":0}]]},"Edit Fields3":{"main":[[{"node":"HTTP Request","type":"main","index":0}]]},"HTTP Request":{"main":[[{"node":"Transcribe a recording","type":"main","index":0}]]},"verifica_numero_cadastrado":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"Postgres Chat Memory":{"ai_memory":[[{"node":"AI Agent","type":"ai_memory","index":0}]]},"Agendamentos_SDR":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"obterClientes":{"ai_tool":[[{"node":"Agendamentos_SDR","type":"ai_tool","index":0}]]},"gpt-16":{"ai_languageModel":[[{"node":"Agendamentos_SDR","type":"ai_languageModel","index":0}]]},"Postgres_Memory7":{"ai_memory":[[{"node":"Agendamentos_SDR","type":"ai_memory","index":0}]]},"adicionarCliente":{"ai_tool":[[{"node":"Agendamentos_SDR","type":"ai_tool","index":0}]]},"Busca o usu√°rio":{"main":[[{"node":"√â qualificado?","type":"main","index":0}]]},"√â qualificado?":{"main":[[{"node":"AI Agent","type":"main","index":0}],[{"node":"No Operation, do nothing3","type":"main","index":0}]]},"Envia mensagem para o Aldo":{"main":[[{"node":"10 segundos","type":"main","index":0}]]},"adicionarAgendamento":{"ai_tool":[[{"node":"Agendamentos_SDR","type":"ai_tool","index":0}]]},"removerAgendamento":{"ai_tool":[[{"node":"Agendamentos_SDR","type":"ai_tool","index":0}]]},"obterAgendamentos":{"ai_tool":[[{"node":"Agendamentos_SDR","type":"ai_tool","index":0}]]},"atualizarAgendamento":{"ai_tool":[[{"node":"Agendamentos_SDR","type":"ai_tool","index":0}]]},"adicionarIDAgendamento":{"ai_tool":[[{"node":"Agendamentos_SDR","type":"ai_tool","index":0}]]},"verificarIDAgendamento":{"ai_tool":[[{"node":"Agendamentos_SDR","type":"ai_tool","index":0}]]},"uuid":{"main":[[{"node":"criaLead","type":"main","index":0}]]},"criaLead":{"main":[[{"node":"15 segundos","type":"main","index":0}]]},"Envia mensagem para a Risolene":{"main":[[{"node":"20 segundos","type":"main","index":0}]]},"15 segundos1":{"main":[[{"node":"Envia mensagem para a Risolene","type":"main","index":0}]]},"20 segundos":{"main":[[{"node":"Envia mensagem para o Davi","type":"main","index":0}]]}},"authors":"Aldo Calesco","name":"Version 570304f2","description":"","autosaved":false},"tags":[]}